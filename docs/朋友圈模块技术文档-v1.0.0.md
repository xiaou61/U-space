# 朋友圈模块技术实现文档 v1.0.0

## 1. 技术架构

### 1.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端用户端     │    │   前端管理端     │    │     后端API     │
│  (vue3-user)   │────│  (vue3-admin)   │────│  (xiaou-moment) │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                        │
                                               ┌─────────────────┐
                                               │   xiaou-common  │
                                               │   (公共模块)     │
                                               └─────────────────┘
                                                        │
                                               ┌─────────────────┐
                                               │    MySQL DB     │
                                               └─────────────────┘
```

### 1.2 技术栈
- **后端**: Spring Boot 3.x + MyBatis + xiaou-common
- **前端**: Vue3 + Element Plus + Pinia
- **数据库**: MySQL 8.0+
- **文件存储**: 集成现有 xiaou-filestorage 模块

## 2. 数据库设计

### 2.1 表结构设计

#### 2.1.1 动态表 (moments)
```sql
CREATE TABLE moments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '动态ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    content TEXT COMMENT '动态内容(最多100字)',
    images TEXT COMMENT '图片URLs，JSON格式存储',
    like_count INT DEFAULT 0 COMMENT '点赞数',
    comment_count INT DEFAULT 0 COMMENT '评论数',
    status TINYINT DEFAULT 1 COMMENT '状态：1正常 0删除 2审核中',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_user_id (user_id),
    INDEX idx_create_time (create_time DESC),
    INDEX idx_status (status),
    INDEX idx_status_time (status, create_time DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT '动态表';
```

#### 2.1.2 点赞表 (moment_likes)
```sql
CREATE TABLE moment_likes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '点赞ID',
    moment_id BIGINT NOT NULL COMMENT '动态ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    UNIQUE KEY uk_moment_user (moment_id, user_id),
    INDEX idx_moment_id (moment_id),
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT '动态点赞表';
```

#### 2.1.3 评论表 (moment_comments)
```sql
CREATE TABLE moment_comments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '评论ID',
    moment_id BIGINT NOT NULL COMMENT '动态ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    content TEXT NOT NULL COMMENT '评论内容(最多200字)',
    status TINYINT DEFAULT 1 COMMENT '状态：1正常 0删除',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_moment_id (moment_id),
    INDEX idx_user_id (user_id),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT '动态评论表';
```

## 3. 后端模块设计

### 3.1 模块结构
```
xiaou-moment/
├── src/main/java/com/xiaou/moment/
│   ├── controller/
│   │   ├── admin/         # 管理端控制器
│   │   └── user/          # 用户端控制器
│   ├── domain/           # 实体类
│   ├── dto/             # 数据传输对象
│   ├── mapper/          # MyBatis映射接口
│   ├── service/         # 业务逻辑层
│   │   └── impl/
│   └── enums/           # 枚举类
└── src/main/resources/
    └── mapper/          # XML映射文件
```

### 3.2 核心实体类

#### 3.2.1 Moment 实体
```java
@Data
public class Moment {
    private Long id;
    private Long userId;
    private String content;
    private String images; // JSON格式存储图片URLs
    private Integer likeCount;
    private Integer commentCount;
    private Integer status; // MomentStatus枚举
    
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private LocalDateTime createTime;
    
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private LocalDateTime updateTime;
}
```

#### 3.2.2 MomentLike 实体
```java
@Data
public class MomentLike {
    private Long id;
    private Long momentId;
    private Long userId;
    
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private LocalDateTime createTime;
}
```

#### 3.2.3 MomentComment 实体
```java
@Data
public class MomentComment {
    private Long id;
    private Long momentId;
    private Long userId;
    private String content;
    private Integer status; // CommentStatus枚举
    
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private LocalDateTime createTime;
    
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private LocalDateTime updateTime;
}
```

### 3.3 枚举定义

```java
@Getter
@AllArgsConstructor
public enum MomentStatus {
    DELETED(0, "已删除"),
    NORMAL(1, "正常"),
    REVIEWING(2, "审核中");
    
    private final Integer code;
    private final String desc;
}

@Getter
@AllArgsConstructor
public enum CommentStatus {
    DELETED(0, "已删除"),
    NORMAL(1, "正常");
    
    private final Integer code;
    private final String desc;
}
```

### 3.4 DTO设计

#### 3.4.1 发布动态请求
```java
@Data
@Valid
public class MomentPublishRequest {
    @NotBlank(message = "动态内容不能为空")
    @Length(min = 1, max = 100, message = "动态内容长度需在1-100字符之间")
    private String content;
    
    @Valid
    private List<String> images;
    
    @AssertTrue(message = "图片数量不能超过9张")
    public boolean isValidImageCount() {
        return images == null || images.size() <= 9;
    }
}
```

#### 3.4.2 动态列表响应
```java
@Data
public class MomentListResponse {
    private Long id;
    private Long userId;
    private String userNickname;
    private String userAvatar;
    private String content;
    private List<String> images;
    private Integer likeCount;
    private Integer commentCount;
    private Boolean isLiked; // 当前用户是否已点赞
    private Boolean canDelete; // 当前用户是否可删除
    
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private LocalDateTime createTime;
    
    private List<CommentResponse> recentComments; // 最新3条评论
}
```

### 3.5 Mapper接口

#### 3.5.1 MomentMapper
```java
@Mapper
public interface MomentMapper {
    int insert(Moment moment);
    
    int deleteById(Long id);
    
    int updateById(Moment moment);
    
    Moment selectById(Long id);
    
    List<Moment> selectList(Map<String, Object> params);
    
    Long selectCount(Map<String, Object> params);
    
    int incrementLikeCount(Long momentId);
    
    int decrementLikeCount(Long momentId);
    
    int incrementCommentCount(Long momentId);
    
    int decrementCommentCount(Long momentId);
}
```

#### 3.5.2 MomentLikeMapper
```java
@Mapper
public interface MomentLikeMapper {
    int insert(MomentLike momentLike);
    
    int deleteById(Long id);
    
    int deleteByMomentIdAndUserId(@Param("momentId") Long momentId, @Param("userId") Long userId);
    
    MomentLike selectByMomentIdAndUserId(@Param("momentId") Long momentId, @Param("userId") Long userId);
    
    List<MomentLike> selectByMomentId(Long momentId);
}
```

## 4. 接口设计

### 4.1 用户端接口

```java
@RestController
@RequestMapping("/api/user/moments")
@RequiredArgsConstructor
public class UserMomentController {
    
    @PostMapping("/publish")
    public Result<Long> publishMoment(@Valid @RequestBody MomentPublishRequest request) {
        // 实现逻辑
    }
    
    @PostMapping("/list")
    public Result<PageResponse<MomentListResponse>> getMomentList(@RequestBody PageRequest pageRequest) {
        // 实现逻辑
    }
    
    @PostMapping("/delete")
    public Result<Void> deleteMoment(@RequestBody IdRequest request) {
        // 实现逻辑
    }
    
    @PostMapping("/{momentId}/like")
    public Result<Boolean> toggleLike(@PathVariable Long momentId) {
        // 实现逻辑
    }
}
```

### 4.2 管理端接口

```java
@RestController
@RequestMapping("/api/admin/moments")
@RequiredArgsConstructor
public class AdminMomentController {
    
    @PostMapping("/list")
    @RequireAdmin
    public Result<PageResponse<AdminMomentListResponse>> getMomentList(@RequestBody AdminMomentListRequest request) {
        // 实现逻辑
    }
    
    @PostMapping("/batch-delete")
    @RequireAdmin
    public Result<Void> batchDeleteMoments(@RequestBody BatchDeleteRequest request) {
        // 实现逻辑
    }
}
```

## 5. 业务逻辑设计

### 5.1 核心业务规则
- 同一用户5分钟内最多发布3条动态
- 内容长度1-100字符，图片最多9张
- 用户只能删除自己的动态和评论
- 动态发布者可删除自己动态下的任意评论
- 点赞使用唯一索引防止重复

### 5.2 关键XML映射

#### 5.2.1 MomentMapper.xml
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xiaou.moment.mapper.MomentMapper">

    <insert id="insert" parameterType="com.xiaou.moment.domain.Moment" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO moments (user_id, content, images, like_count, comment_count, status)
        VALUES (#{userId}, #{content}, #{images}, #{likeCount}, #{commentCount}, #{status})
    </insert>

    <select id="selectList" parameterType="map" resultType="com.xiaou.moment.domain.Moment">
        SELECT * FROM moments
        WHERE status = 1
        <if test="userId != null">
            AND user_id = #{userId}
        </if>
        ORDER BY create_time DESC
        <if test="offset != null and size != null">
            LIMIT #{offset}, #{size}
        </if>
    </select>

    <update id="incrementLikeCount" parameterType="long">
        UPDATE moments SET like_count = like_count + 1 WHERE id = #{momentId}
    </update>

    <update id="decrementLikeCount" parameterType="long">
        UPDATE moments SET like_count = like_count - 1 WHERE id = #{momentId} AND like_count &gt; 0
    </update>

</mapper>
```

## 6. 前端实现方案

### 6.1 用户端路由
```javascript
// router/index.js
{
  path: '/moments',
  name: 'Moments',
  component: () => import('@/views/moments/Index.vue'),
  meta: { requiresAuth: true, title: '朋友圈' }
}
```

### 6.2 API封装
```javascript
// api/moment.js
import request from '@/utils/request'

export function publishMoment(data) {
  return request.post('/api/user/moments/publish', data)
}

export function getMomentList(data) {
  return request.post('/api/user/moments/list', data)
}

export function toggleLike(momentId) {
  return request.post(`/api/user/moments/${momentId}/like`)
}

export function deleteMoment(data) {
  return request.post('/api/user/moments/delete', data)
}
```

### 6.3 管理端导航菜单
需要在 `vue3-admin-front/src/layout/index.vue` 中添加：
```vue
<el-sub-menu index="moments">
  <template #title>
    <el-icon><ChatDotRound /></el-icon>
    <span>朋友圈管理</span>
  </template>
  <el-menu-item index="/moments/list">动态管理</el-menu-item>
  <el-menu-item index="/moments/comments">评论管理</el-menu-item>
</el-sub-menu>
```

## 7. 部署配置

### 7.1 模块依赖
```xml
<!-- xiaou-moment/pom.xml -->
<dependencies>
    <dependency>
        <groupId>com.xiaou</groupId>
        <artifactId>xiaou-common</artifactId>
        <version>1.0.0</version>
    </dependency>
</dependencies>
```

### 7.2 数据库迁移脚本
```sql
-- 文件名: sql/moment_module.sql
-- 执行上述三个表的创建语句
```

## 8. 管理后台功能详细设计

### 8.1 动态管理功能

#### 8.1.1 动态列表管理
**页面路径**: `/moments/list`
**功能特性**:
- 分页展示所有用户动态
- 支持按用户昵称、发布时间、状态等条件筛选
- 显示动态内容、图片、点赞数、评论数、发布用户等信息
- 支持单个删除和批量删除操作
- 支持查看动态详情（包含所有评论）

#### 8.1.2 敏感内容审核
**功能特性**:
- 敏感词标记：系统自动标记含敏感词的动态
- 人工审核：管理员可手动审核标记的动态
- 审核操作：通过/拒绝/删除
- 审核日志：记录审核操作历史

#### 8.1.3 批量管理工具
**功能特性**:
- 批量删除违规动态
- 批量设置动态状态
- 导出动态数据（Excel格式）

### 8.2 评论管理功能

#### 8.2.1 评论列表管理  
**页面路径**: `/moments/comments`
**功能特性**:
- 分页展示所有评论
- 支持按动态ID、用户昵称、评论时间筛选
- 显示评论内容、所属动态、评论用户等信息
- 支持删除违规评论
- 支持查看评论所属的原动态

#### 8.2.2 评论审核
**功能特性**:
- 敏感评论标记和人工审核
- 评论举报处理
- 评论删除和恢复操作

### 8.3 数据统计分析

#### 8.3.1 运营数据统计
**页面路径**: `/moments/statistics`
**核心指标**:
- 每日/每周/每月动态发布数量趋势
- 活跃用户数统计
- 点赞、评论总数统计
- 用户互动率分析

#### 8.3.2 用户行为分析
**功能特性**:
- 发布动态最多的用户排行榜
- 获得点赞最多的动态排行
- 用户活跃时间段分析
- 内容类型分布统计（文字、图片比例）

#### 8.3.3 数据导出功能
**功能特性**:
- 统计报表导出（Excel/PDF）
- 自定义时间范围数据导出
- 定期数据报告生成

### 8.4 管理后台接口扩展

#### 8.4.1 管理端专用DTO
```java
// 管理端动态列表响应
@Data
public class AdminMomentListResponse {
    private Long id;
    private Long userId;
    private String userNickname;
    private String content;
    private List<String> images;
    private Integer likeCount;
    private Integer commentCount;
    private Integer status;
    private String statusDesc;
    private Boolean hasSensitiveWord; // 是否包含敏感词
    
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private LocalDateTime createTime;
}

// 统计数据响应
@Data
public class MomentStatisticsResponse {
    private Long totalMoments;       // 总动态数
    private Long totalLikes;         // 总点赞数  
    private Long totalComments;      // 总评论数
    private Long activeUsers;        // 活跃用户数
    private List<DailyStatistics> dailyStats; // 每日统计
}

// 每日统计数据
@Data
public class DailyStatistics {
    private String date;
    private Long momentCount;
    private Long likeCount;
    private Long commentCount;
    private Long activeUserCount;
}
```

#### 8.4.2 管理端查询条件
```java
// 管理端动态列表查询
@Data
public class AdminMomentListRequest extends PageRequest {
    private String userNickname;     // 用户昵称
    private Integer status;          // 状态筛选
    private Boolean hasSensitiveWord; // 是否包含敏感词
    private String startDate;        // 开始时间
    private String endDate;          // 结束时间
}

// 统计查询条件
@Data
public class StatisticsRequest {
    private String startDate;
    private String endDate;
    private String type; // daily/weekly/monthly
}
```

### 8.5 前端管理页面设计

#### 8.5.1 导航菜单结构
在 `vue3-admin-front/src/layout/index.vue` 中添加：
```vue
<el-sub-menu index="moments">
  <template #title>
    <el-icon><ChatDotRound /></el-icon>
    <span>朋友圈管理</span>
  </template>
  <el-menu-item index="/moments/list">动态管理</el-menu-item>
  <el-menu-item index="/moments/comments">评论管理</el-menu-item>
  <el-menu-item index="/moments/statistics">数据统计</el-menu-item>
  <el-menu-item index="/moments/audit">内容审核</el-menu-item>
</el-sub-menu>
```

#### 8.5.2 管理端路由配置
```javascript
// vue3-admin-front/src/router/index.js
{
  path: '/moments',
  name: 'MomentsManagement',
  children: [
    {
      path: 'list',
      component: () => import('@/views/moments/List.vue'),
      meta: { title: '动态管理', requiresAuth: true }
    },
    {
      path: 'comments',
      component: () => import('@/views/moments/Comments.vue'),
      meta: { title: '评论管理', requiresAuth: true }
    },
    {
      path: 'statistics',
      component: () => import('@/views/moments/Statistics.vue'),
      meta: { title: '数据统计', requiresAuth: true }
    },
    {
      path: 'audit',
      component: () => import('@/views/moments/Audit.vue'),
      meta: { title: '内容审核', requiresAuth: true }
    }
  ]
}
```

#### 8.5.3 管理端API封装
```javascript
// vue3-admin-front/src/api/moments.js
import request from '@/utils/request'

// 获取动态列表（管理端）
export function getAdminMomentList(data) {
  return request.post('/api/admin/moments/list', data)
}

// 批量删除动态
export function batchDeleteMoments(data) {
  return request.post('/api/admin/moments/batch-delete', data)
}

// 获取统计数据
export function getMomentStatistics(data) {
  return request.post('/api/admin/moments/statistics', data)
}

// 获取评论列表（管理端）
export function getAdminCommentList(data) {
  return request.post('/api/admin/moments/comments/list', data)
}

// 删除评论
export function deleteComment(data) {
  return request.post('/api/admin/moments/comments/delete', data)
}
```

## 9. 开发计划

### Phase 1：基础功能（1周）
- 数据库表结构创建
- 后端基础CRUD接口
- 前端页面框架

### Phase 2：核心功能（1周）  
- 动态发布和展示功能
- 点赞和评论功能
- 管理端基础功能

### Phase 3：管理后台完善（1周）
- 管理端动态和评论管理功能
- 数据统计和分析功能
- 内容审核功能

### Phase 4：完善优化（0.5周）
- 功能测试和优化
- 前端交互完善

---

**文档版本**: v1.0.0  
**技术栈**: Spring Boot + MyBatis + Vue3
