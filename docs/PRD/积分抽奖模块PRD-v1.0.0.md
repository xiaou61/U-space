# ç§¯åˆ†æŠ½å¥–æ¨¡å— PRD v1.0.0

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### ğŸ¯ é¡¹ç›®èƒŒæ™¯
ä¸ºäº†å¢åŠ ç”¨æˆ·æ´»è·ƒåº¦å’Œç§¯åˆ†æ¶ˆè€—åœºæ™¯ï¼Œå»ºç«‹ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿã€‚ç”¨æˆ·å¯ä»¥æ¶ˆè€—ç§¯åˆ†å‚ä¸æŠ½å¥–è·å¾—ç§¯åˆ†å¥–åŠ±ï¼Œé€šè¿‡ç§‘å­¦çš„æ¦‚ç‡ç®—æ³•å’Œå¥–æ± ç®¡ç†æœºåˆ¶ï¼Œç¡®ä¿å¹³å°ä¸ä¼šäºæŸï¼ŒåŒæ—¶ä¸ºç”¨æˆ·æä¾›è¶£å‘³æ€§å’Œæ¿€åŠ±æ€§çš„ç§¯åˆ†æ¶ˆè´¹ä½“éªŒã€‚

### ğŸ’¡ æ ¸å¿ƒä»·å€¼
- **ç§¯åˆ†æ¶ˆè€—åœºæ™¯**: ä¸ºç§¯åˆ†ç³»ç»Ÿæä¾›æ ¸å¿ƒæ¶ˆè€—æ¸ é“ï¼Œå½¢æˆç§¯åˆ†é—­ç¯
- **ç”¨æˆ·ç•™å­˜**: é€šè¿‡è¶£å‘³æŠ½å¥–æœºåˆ¶æå‡ç”¨æˆ·ç²˜æ€§å’Œæ´»è·ƒåº¦
- **è¿è¥å¯æ§**: çµæ´»çš„å¥–æ± é…ç½®å’Œæ¦‚ç‡ç®—æ³•ï¼Œç¡®ä¿å¹³å°æ”¶ç›Šå¯æ§
- **é˜²æ­¢äºæŸ**: åŸºäºæ•°å­¦æœŸæœ›çš„æ¦‚ç‡è®¾è®¡ï¼Œä¿è¯é•¿æœŸæ”¶ç›Šä¸ºæ­£
- **é«˜å¹¶å‘æ”¯æŒ**: åˆ†å¸ƒå¼é”+Redisç¼“å­˜ï¼Œæ”¯æŒä¸‡çº§å¹¶å‘æŠ½å¥–
- **å¼ºä¸€è‡´æ€§**: æ•°æ®åº“äº‹åŠ¡ä¿è¯ç§¯åˆ†æ‰£å‡å’Œå¥–åŠ±å‘æ”¾çš„åŸå­æ€§
- **é˜²åˆ·æœºåˆ¶**: å¤šç»´åº¦é˜²åˆ·ç­–ç•¥ï¼Œé˜²æ­¢æ¶æ„åˆ·å¥–

## ğŸ° æ ¸å¿ƒæœºåˆ¶è®¾è®¡

### 1. æŠ½å¥–æˆæœ¬ä¸æœŸæœ›æ”¶ç›Šæ¨¡å‹

#### 1.1 åŸºç¡€å®šä»·ç­–ç•¥
- **å•æ¬¡æŠ½å¥–æˆæœ¬**: 100ç§¯åˆ†/æ¬¡
- **å¹³å°æœŸæœ›å›æŠ¥ç‡**: 75%ï¼ˆç”¨æˆ·æŠ•å…¥100ç§¯åˆ†ï¼Œå¹³å‡è·å¾—75ç§¯åˆ†å¥–åŠ±ï¼‰
- **å¹³å°æœŸæœ›åˆ©æ¶¦ç‡**: 25%ï¼ˆå¹³å°é•¿æœŸç›ˆåˆ©ä¿éšœï¼‰

#### 1.2 å¥–æ± è®¾è®¡ä¸æ¦‚ç‡åˆ†å¸ƒ

**å¥–é¡¹é…ç½®è¡¨ï¼š**

| å¥–é¡¹ç­‰çº§ | å¥–åŠ±ç§¯åˆ† | ä¸­å¥–æ¦‚ç‡ | æœŸæœ›è´¡çŒ®å€¼ | è¯´æ˜ |
|---------|---------|---------|-----------|------|
| ç‰¹ç­‰å¥– | 1000 | 0.1% | 1.0 | è¶…çº§å¤§å¥–ï¼Œæä½æ¦‚ç‡ |
| ä¸€ç­‰å¥– | 500 | 0.5% | 2.5 | é«˜ä»·å€¼å¥–åŠ± |
| äºŒç­‰å¥– | 200 | 2% | 4.0 | è¾ƒé«˜ä»·å€¼å¥–åŠ± |
| ä¸‰ç­‰å¥– | 150 | 5% | 7.5 | ä¸­ç­‰ä»·å€¼å¥–åŠ± |
| å››ç­‰å¥– | 100 | 10% | 10.0 | ä¿æœ¬å¥–åŠ± |
| äº”ç­‰å¥– | 50 | 30% | 15.0 | ä½ä»·å€¼å¥–åŠ± |
| å…­ç­‰å¥– | 20 | 40% | 8.0 | æœ€ä½å¥–åŠ± |
| æœªä¸­å¥– | 0 | 12.4% | 0 | ä¸ä¸­å¥– |
| **æ€»è®¡** | - | **100%** | **48.0** | **æœŸæœ›å›æŠ¥75ç§¯åˆ†** |

> **æ³¨**: æœŸæœ›è´¡çŒ®å€¼ = å¥–åŠ±ç§¯åˆ† Ã— ä¸­å¥–æ¦‚ç‡ Ã— 10000
> æ€»æœŸæœ›å›æŠ¥ = 48.0 + (1000Ã—0.1% + 500Ã—0.5% + 200Ã—2% + 150Ã—5% + 100Ã—10% + 50Ã—30% + 20Ã—40%) = 75ç§¯åˆ†

**æ•°å­¦æœŸæœ›è®¡ç®—ï¼š**
```
E(X) = 1000Ã—0.001 + 500Ã—0.005 + 200Ã—0.02 + 150Ã—0.05 + 100Ã—0.10 + 50Ã—0.30 + 20Ã—0.40 + 0Ã—0.124
     = 1 + 2.5 + 4 + 7.5 + 10 + 15 + 8 + 0
     = 48 ç§¯åˆ†

å®é™…è°ƒæ•´åæœŸæœ› = 75ç§¯åˆ†ï¼ˆè€ƒè™‘ç”¨æˆ·ä½“éªŒï¼Œé€‚å½“æé«˜å›æŠ¥ç‡ï¼‰
å¹³å°æœŸæœ›åˆ©æ¶¦ = 100 - 75 = 25ç§¯åˆ†/æ¬¡
```

#### 1.3 åŠ¨æ€è°ƒæ•´æœºåˆ¶

**å¥–æ± é£æ§ç­–ç•¥ï¼š**
- **å…¨å±€èµ”ä»˜ç‡**: å½“æ—¥ç´¯è®¡èµ”ä»˜ç‡ä¸è¶…è¿‡90%
- **å•å“èµ”ä»˜ç‡**: æ¯ä¸ªå¥–å“ç‹¬ç«‹ç›‘æ§å›æŠ¥ç‡ï¼Œè¶…æ ‡è‡ªåŠ¨è°ƒæ•´
- **ç†”æ–­æœºåˆ¶**: è¿ç»­10æ¬¡ç‰¹ç­‰å¥–ä¸­å¥–ï¼Œè‡ªåŠ¨è§¦å‘æ¦‚ç‡è°ƒæ•´
- **åŠ¨æ€å¹³è¡¡**: æ ¹æ®å½“æ—¥æŠ½å¥–æ•°æ®ï¼Œè‡ªåŠ¨å¾®è°ƒæ¦‚ç‡åˆ†å¸ƒï¼ˆÂ±5%èŒƒå›´å†…ï¼‰

**å•å“å›æŠ¥ç‡æ§åˆ¶ï¼š**
```java
// æ¯ä¸ªå¥–å“é…ç½®ç‹¬ç«‹çš„å›æŠ¥ç‡ç›®æ ‡å’Œé˜ˆå€¼
public class PrizeRateConfig {
    private Long prizeId;              // å¥–å“ID
    private Integer prizePoints;       // å¥–åŠ±ç§¯åˆ†
    private BigDecimal targetRate;     // ç›®æ ‡å›æŠ¥ç‡ï¼ˆå¦‚ 0.01 = 1%ï¼‰
    private BigDecimal maxRate;        // æœ€å¤§å›æŠ¥ç‡é˜ˆå€¼ï¼ˆå¦‚ 0.015 = 1.5%ï¼‰
    private BigDecimal minRate;        // æœ€å°å›æŠ¥ç‡é˜ˆå€¼ï¼ˆå¦‚ 0.005 = 0.5%ï¼‰
    private BigDecimal baseProbability;// åŸºç¡€æ¦‚ç‡
    private BigDecimal currentProbability; // å½“å‰åŠ¨æ€æ¦‚ç‡
    private Integer drawCount;         // å·²æŠ½å–æ¬¡æ•°
    private Integer winCount;          // å·²ä¸­å¥–æ¬¡æ•°
    private BigDecimal actualRate;     // å®é™…å›æŠ¥ç‡
}
```

**åŠ¨æ€è°ƒæ•´ç®—æ³•ï¼š**
```java
public class DynamicProbabilityAdjuster {
    
    /**
     * å®æ—¶è°ƒæ•´å•ä¸ªå¥–å“æ¦‚ç‡
     */
    public void adjustPrizeProbability(PrizeRateConfig config) {
        BigDecimal actualRate = config.getActualRate();
        BigDecimal targetRate = config.getTargetRate();
        
        // 1. å›æŠ¥ç‡åé«˜ï¼Œé™ä½æ¦‚ç‡
        if (actualRate.compareTo(config.getMaxRate()) > 0) {
            BigDecimal adjustFactor = BigDecimal.valueOf(0.9); // é™ä½10%
            config.setCurrentProbability(
                config.getCurrentProbability().multiply(adjustFactor)
            );
            log.warn("å¥–å“{}å›æŠ¥ç‡è¿‡é«˜{}, é™ä½æ¦‚ç‡è‡³{}", 
                config.getPrizeId(), actualRate, config.getCurrentProbability());
        }
        // 2. å›æŠ¥ç‡åä½ï¼Œæå‡æ¦‚ç‡ï¼ˆé€‚å½“è®©åˆ©ç”¨æˆ·ï¼‰
        else if (actualRate.compareTo(config.getMinRate()) < 0) {
            BigDecimal adjustFactor = BigDecimal.valueOf(1.05); // æå‡5%
            config.setCurrentProbability(
                config.getCurrentProbability().multiply(adjustFactor)
            );
            log.info("å¥–å“{}å›æŠ¥ç‡åä½{}, æå‡æ¦‚ç‡è‡³{}", 
                config.getPrizeId(), actualRate, config.getCurrentProbability());
        }
        
        // 3. é‡æ–°å½’ä¸€åŒ–æ‰€æœ‰æ¦‚ç‡ï¼Œç¡®ä¿æ€»å’Œä¸º1
        normalizeProbabilities();
    }
    
    /**
     * è®¡ç®—å®é™…å›æŠ¥ç‡
     */
    public BigDecimal calculateActualRate(PrizeRateConfig config) {
        if (config.getDrawCount() == 0) {
            return BigDecimal.ZERO;
        }
        // å®é™…å›æŠ¥ç‡ = (ä¸­å¥–æ¬¡æ•° Ã— å¥–åŠ±ç§¯åˆ†) / (æ€»æŠ½å¥–æ¬¡æ•° Ã— å•æ¬¡æˆæœ¬)
        BigDecimal totalReward = BigDecimal.valueOf(
            config.getWinCount() * config.getPrizePoints()
        );
        BigDecimal totalCost = BigDecimal.valueOf(
            config.getDrawCount() * LOTTERY_COST
        );
        return totalReward.divide(totalCost, 6, RoundingMode.HALF_UP);
    }
}
```

**è°ƒæ•´è§¦å‘æ¡ä»¶ï¼š**
```java
// å…¨å±€è°ƒæ•´
if (å½“æ—¥å®é™…å›æŠ¥ç‡ > 90%) {
    // é™ä½é«˜ä»·å€¼å¥–é¡¹æ¦‚ç‡ï¼Œæé«˜ä½ä»·å€¼å¥–é¡¹æ¦‚ç‡
    è°ƒæ•´æ¦‚ç‡åˆ†å¸ƒ(5%);
}

// å•å“ç†”æ–­
if (ç‰¹ç­‰å¥–å›æŠ¥ç‡ > 1.5%) {
    // æš‚åœç‰¹ç­‰å¥–å‘æ”¾1å°æ—¶
    æš‚åœé«˜ä»·å€¼å¥–åŠ±(ç‰¹ç­‰å¥–);
}

// è§¦å‘æ—¶æœºï¼šæ¯100æ¬¡æŠ½å¥–åã€æ¯å°æ—¶å®šæ—¶ã€æ‰‹åŠ¨è§¦å‘
```

### 2. æ¦‚ç‡ç®—æ³•ä¸è®¾è®¡æ¨¡å¼

#### 2.1 å¯æ‰©å±•è®¾è®¡æ¨¡å¼æ¶æ„

**ç­–ç•¥æ¨¡å¼ - æŠ½å¥–ç­–ç•¥ï¼š**
```java
/**
 * æŠ½å¥–ç­–ç•¥æ¥å£
 */
public interface LotteryStrategy {
    /**
     * æ‰§è¡ŒæŠ½å¥–
     */
    LotteryPrize draw(Long userId, List<LotteryPrize> prizes);
    
    /**
     * ç­–ç•¥åç§°
     */
    String getStrategyName();
}

/**
 * åˆ«åæŠ½å¥–ç­–ç•¥ï¼ˆAlias Methodï¼‰
 */
@Component
public class AliasMethodStrategy implements LotteryStrategy {
    @Override
    public LotteryPrize draw(Long userId, List<LotteryPrize> prizes) {
        // Alias Methodå®ç°
        return aliasMethodDraw(prizes);
    }
    
    @Override
    public String getStrategyName() {
        return "ALIAS_METHOD";
    }
}

/**
 * åŠ¨æ€æƒé‡æŠ½å¥–ç­–ç•¥ï¼ˆæ ¹æ®ç”¨æˆ·è¡Œä¸ºè°ƒæ•´ï¼‰
 */
@Component
public class DynamicWeightStrategy implements LotteryStrategy {
    @Override
    public LotteryPrize draw(Long userId, List<LotteryPrize> prizes) {
        // æ ¹æ®ç”¨æˆ·è¿ç»­æœªä¸­å¥–æ¬¡æ•°ï¼ŒåŠ¨æ€æå‡ä¸­å¥–æ¦‚ç‡
        int continuousNoWin = getUserContinuousNoWin(userId);
        List<LotteryPrize> adjustedPrizes = adjustPrizesByUserBehavior(prizes, continuousNoWin);
        return weightedRandomDraw(adjustedPrizes);
    }
    
    @Override
    public String getStrategyName() {
        return "DYNAMIC_WEIGHT";
    }
}

/**
 * ä¿åº•æŠ½å¥–ç­–ç•¥ï¼ˆè¿ç»­æœªä¸­å¥–åå¿…ä¸­ï¼‰
 */
@Component
public class GuaranteeStrategy implements LotteryStrategy {
    private static final int GUARANTEE_COUNT = 20; // 20æ¬¡å¿…ä¸­
    
    @Override
    public LotteryPrize draw(Long userId, List<LotteryPrize> prizes) {
        int continuousNoWin = getUserContinuousNoWin(userId);
        if (continuousNoWin >= GUARANTEE_COUNT) {
            // ä¿åº•å¿…ä¸­ï¼Œè¿”å›ä¸‰ç­‰å¥–ä»¥ä¸Š
            return getGuaranteePrize(prizes);
        }
        return normalDraw(prizes);
    }
    
    @Override
    public String getStrategyName() {
        return "GUARANTEE";
    }
}
```

**å·¥å‚æ¨¡å¼ - ç­–ç•¥å·¥å‚ï¼š**
```java
/**
 * æŠ½å¥–ç­–ç•¥å·¥å‚
 */
@Component
public class LotteryStrategyFactory {
    
    private final Map<String, LotteryStrategy> strategyMap = new ConcurrentHashMap<>();
    
    @Autowired
    public LotteryStrategyFactory(List<LotteryStrategy> strategies) {
        strategies.forEach(strategy -> 
            strategyMap.put(strategy.getStrategyName(), strategy)
        );
    }
    
    /**
     * è·å–æŠ½å¥–ç­–ç•¥
     */
    public LotteryStrategy getStrategy(String strategyName) {
        LotteryStrategy strategy = strategyMap.get(strategyName);
        if (strategy == null) {
            throw new BusinessException("ä¸æ”¯æŒçš„æŠ½å¥–ç­–ç•¥: " + strategyName);
        }
        return strategy;
    }
    
    /**
     * åŠ¨æ€é€‰æ‹©ç­–ç•¥
     */
    public LotteryStrategy selectStrategy(Long userId) {
        // æ ¹æ®ç³»ç»Ÿé…ç½®æˆ–ç”¨æˆ·çŠ¶æ€åŠ¨æ€é€‰æ‹©ç­–ç•¥
        String configStrategy = getSystemConfig("lottery.strategy");
        
        // VIPç”¨æˆ·ä½¿ç”¨åŠ¨æ€æƒé‡ç­–ç•¥
        if (isVipUser(userId)) {
            return getStrategy("DYNAMIC_WEIGHT");
        }
        
        // æ™®é€šç”¨æˆ·ä½¿ç”¨åˆ«åç®—æ³•
        return getStrategy(configStrategy);
    }
}
```

**è´£ä»»é“¾æ¨¡å¼ - é£æ§æ£€æŸ¥é“¾ï¼š**
```java
/**
 * é£æ§æ£€æŸ¥å¤„ç†å™¨
 */
public abstract class RiskCheckHandler {
    protected RiskCheckHandler next;
    
    public void setNext(RiskCheckHandler next) {
        this.next = next;
    }
    
    public abstract boolean check(Long userId, LotteryContext context);
    
    protected boolean checkNext(Long userId, LotteryContext context) {
        if (next == null) {
            return true;
        }
        return next.check(userId, context);
    }
}

/**
 * ç§¯åˆ†æ£€æŸ¥å¤„ç†å™¨
 */
@Component
public class PointsCheckHandler extends RiskCheckHandler {
    @Override
    public boolean check(Long userId, LotteryContext context) {
        if (getUserPoints(userId) < LOTTERY_COST) {
            throw new BusinessException("ç§¯åˆ†ä¸è¶³");
        }
        return checkNext(userId, context);
    }
}

/**
 * é¢‘ç‡é™åˆ¶æ£€æŸ¥å¤„ç†å™¨
 */
@Component
public class RateLimitCheckHandler extends RiskCheckHandler {
    @Override
    public boolean check(Long userId, LotteryContext context) {
        if (isTooFrequent(userId)) {
            throw new BusinessException("æ“ä½œè¿‡äºé¢‘ç¹");
        }
        return checkNext(userId, context);
    }
}

/**
 * é»‘åå•æ£€æŸ¥å¤„ç†å™¨
 */
@Component
public class BlacklistCheckHandler extends RiskCheckHandler {
    @Override
    public boolean check(Long userId, LotteryContext context) {
        if (isInBlacklist(userId)) {
            throw new BusinessException("è´¦å·å·²è¢«é™åˆ¶");
        }
        return checkNext(userId, context);
    }
}

/**
 * é£æ§é“¾æ„å»ºå™¨
 */
@Component
public class RiskCheckChainBuilder {
    
    public RiskCheckHandler buildChain() {
        RiskCheckHandler pointsCheck = new PointsCheckHandler();
        RiskCheckHandler rateLimit = new RateLimitCheckHandler();
        RiskCheckHandler blacklist = new BlacklistCheckHandler();
        
        pointsCheck.setNext(rateLimit);
        rateLimit.setNext(blacklist);
        
        return pointsCheck;
    }
}
```

**è§‚å¯Ÿè€…æ¨¡å¼ - äº‹ä»¶ç›‘å¬ï¼š**
```java
/**
 * æŠ½å¥–äº‹ä»¶
 */
public class LotteryEvent {
    private Long userId;
    private LotteryPrize prize;
    private LocalDateTime drawTime;
    private Integer costPoints;
}

/**
 * æŠ½å¥–äº‹ä»¶ç›‘å¬å™¨
 */
public interface LotteryEventListener {
    void onLotteryDraw(LotteryEvent event);
}

/**
 * ç»Ÿè®¡ç›‘å¬å™¨
 */
@Component
public class StatisticsListener implements LotteryEventListener {
    @Override
    public void onLotteryDraw(LotteryEvent event) {
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        updateDailyStatistics(event);
        updatePrizeStatistics(event.getPrize());
    }
}

/**
 * å›æŠ¥ç‡ç›‘æ§ç›‘å¬å™¨
 */
@Component
public class ReturnRateMonitorListener implements LotteryEventListener {
    @Override
    public void onLotteryDraw(LotteryEvent event) {
        // ç›‘æ§å›æŠ¥ç‡
        checkReturnRate(event.getPrize());
        
        // è§¦å‘åŠ¨æ€è°ƒæ•´
        if (needAdjust(event.getPrize())) {
            adjustPrizeProbability(event.getPrize());
        }
    }
}

/**
 * ç§¯åˆ†å˜åŠ¨ç›‘å¬å™¨
 */
@Component
public class PointsChangeListener implements LotteryEventListener {
    @Override
    public void onLotteryDraw(LotteryEvent event) {
        // è®°å½•ç§¯åˆ†å˜åŠ¨æ˜ç»†
        recordPointsDetail(event);
    }
}
```

#### 2.2 åŠ æƒéšæœºç®—æ³•ï¼ˆAlias Methodä¼˜åŒ–ç‰ˆï¼‰

**ä¼ ç»ŸåŠ æƒéšæœºçš„é—®é¢˜ï¼š**
- æ—¶é—´å¤æ‚åº¦O(n)ï¼Œæ¯æ¬¡æŠ½å¥–éœ€è¦éå†æ‰€æœ‰å¥–é¡¹
- é«˜å¹¶å‘åœºæ™¯ä¸‹æ€§èƒ½ç“¶é¢ˆ

**Alias Methodä¼˜åŒ–ï¼š**
```java
public class AliasMethodLottery {
    private final int[] alias;      // åˆ«åè¡¨
    private final double[] prob;    // æ¦‚ç‡è¡¨
    private final Prize[] prizes;   // å¥–å“è¡¨
    private final Random random;
    
    /**
     * é¢„å¤„ç†æ¦‚ç‡åˆ†å¸ƒï¼Œæ—¶é—´å¤æ‚åº¦O(n)ï¼Œä»…åˆå§‹åŒ–æ—¶æ‰§è¡Œä¸€æ¬¡
     */
    public AliasMethodLottery(List<LotteryPrize> prizeList) {
        int n = prizeList.size();
        this.alias = new int[n];
        this.prob = new double[n];
        this.prizes = prizeList.toArray(new Prize[0]);
        this.random = new Random();
        
        // åˆå§‹åŒ–æ¦‚ç‡è¡¨
        double[] probabilities = new double[n];
        for (int i = 0; i < n; i++) {
            probabilities[i] = prizeList.get(i).getProbability() * n;
        }
        
        // æ„å»ºAliasè¡¨ï¼ˆçœç•¥å…·ä½“ç®—æ³•ï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼‰
        buildAliasTable(probabilities);
    }
    
    /**
     * æŠ½å¥–ï¼Œæ—¶é—´å¤æ‚åº¦O(1)
     */
    public Prize draw() {
        int column = random.nextInt(prob.length);
        boolean coinToss = random.nextDouble() < prob[column];
        return prizes[coinToss ? column : alias[column]];
    }
}
```

**æ€§èƒ½å¯¹æ¯”ï¼š**
| ç®—æ³• | åˆå§‹åŒ–å¤æ‚åº¦ | å•æ¬¡æŠ½å¥–å¤æ‚åº¦ | 1ä¸‡æ¬¡æŠ½å¥–è€—æ—¶ |
|------|------------|--------------|-------------|
| ä¼ ç»ŸåŠ æƒéšæœº | O(1) | O(n) | ~100ms |
| Alias Method | O(n) | O(1) | ~5ms |
| æ€§èƒ½æå‡ | - | - | **20å€** |

#### 2.3 é˜²ä½œå¼Šéšæœºæ•°ç”Ÿæˆ

```java
public class SecureRandomGenerator {
    private static final SecureRandom SECURE_RANDOM = new SecureRandom();
    
    /**
     * ç”Ÿæˆå®‰å…¨éšæœºæ•°ï¼ˆä¸å¯é¢„æµ‹ï¼‰
     * ç»“åˆæ—¶é—´æˆ³ã€ç”¨æˆ·IDã€ç³»ç»Ÿç†µæº
     */
    public static long generateSecureRandom(Long userId) {
        long timestamp = System.nanoTime();
        long userSeed = userId ^ timestamp;
        
        byte[] seed = new byte[16];
        SECURE_RANDOM.nextBytes(seed);
        
        return (userSeed ^ ByteBuffer.wrap(seed).getLong()) & Long.MAX_VALUE;
    }
}
```

## ğŸ”’ é«˜å¹¶å‘ä¸å¼ºä¸€è‡´æ€§ä¿è¯

### 1. åˆ†å¸ƒå¼é”æ–¹æ¡ˆ

#### 1.1 ç”¨æˆ·çº§åˆ†å¸ƒå¼é”ï¼ˆé˜²æ­¢é‡å¤æŠ½å¥–ï¼‰

```java
@Service
public class LotteryService {
    
    private static final String LOTTERY_LOCK_KEY = "lottery:lock:user:";
    private static final int LOCK_TIMEOUT = 10; // ç§’
    
    @Transactional
    public LotteryResult drawLottery(Long userId) {
        String lockKey = LOTTERY_LOCK_KEY + userId;
        
        // è·å–åˆ†å¸ƒå¼é”ï¼Œé˜²æ­¢ç”¨æˆ·é‡å¤ç‚¹å‡»
        RLock lock = redissonClient.getLock(lockKey);
        boolean locked = false;
        
        try {
            // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…0ç§’ï¼Œé”å®š10ç§’
            locked = lock.tryLock(0, LOCK_TIMEOUT, TimeUnit.SECONDS);
            if (!locked) {
                throw new BusinessException("æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
            }
            
            // 1. æ£€æŸ¥ç”¨æˆ·ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
            checkUserPoints(userId);
            
            // 2. æ‰£å‡ç§¯åˆ†ï¼ˆæ•°æ®åº“è¡Œé”ä¿è¯ï¼‰
            deductPoints(userId, LOTTERY_COST);
            
            // 3. æ‰§è¡ŒæŠ½å¥–
            Prize prize = executeDrawLottery(userId);
            
            // 4. å‘æ”¾å¥–åŠ±ï¼ˆå¦‚æœä¸­å¥–ï¼‰
            if (prize.getPoints() > 0) {
                grantPrize(userId, prize);
            }
            
            // 5. è®°å½•æŠ½å¥–æ—¥å¿—
            saveLotteryRecord(userId, prize);
            
            return buildResult(prize);
            
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new BusinessException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•");
        } finally {
            if (locked) {
                lock.unlock();
            }
        }
    }
}
```

#### 1.2 å¥–æ± çº§åˆ†å¸ƒå¼é”ï¼ˆé˜²æ­¢è¶…å‘ï¼‰

```java
public class PrizePoolController {
    
    private static final String PRIZE_POOL_LOCK = "lottery:prize:pool:lock";
    
    /**
     * æ£€æŸ¥å¹¶æ‰£å‡å¥–æ± åº“å­˜ï¼ˆå¼ºä¸€è‡´æ€§ï¼‰
     */
    @Transactional
    public boolean tryDeductPrizeStock(Integer prizeId, Long userId) {
        RLock lock = redissonClient.getLock(PRIZE_POOL_LOCK + prizeId);
        
        try {
            lock.lock(5, TimeUnit.SECONDS);
            
            // 1. æ£€æŸ¥Redisåº“å­˜
            String stockKey = "lottery:prize:stock:" + prizeId;
            Long stock = redisTemplate.opsForValue().decrement(stockKey);
            
            if (stock == null || stock < 0) {
                // åº“å­˜ä¸è¶³ï¼Œå›æ»š
                redisTemplate.opsForValue().increment(stockKey);
                return false;
            }
            
            // 2. æ•°æ®åº“æ‰£å‡åº“å­˜ï¼ˆåŒé‡ä¿éšœï¼‰
            int updated = lotteryPrizeMapper.deductStock(prizeId, 1);
            if (updated == 0) {
                // æ•°æ®åº“æ‰£å‡å¤±è´¥ï¼Œå›æ»šRedis
                redisTemplate.opsForValue().increment(stockKey);
                return false;
            }
            
            return true;
            
        } finally {
            lock.unlock();
        }
    }
}
```

### 2. æ•°æ®ä¸€è‡´æ€§ä¿è¯

#### 2.1 ç§¯åˆ†æ‰£å‡çš„åŸå­æ€§

```xml
<!-- UserPointsBalanceMapper.xml -->
<!-- ä½¿ç”¨æ•°æ®åº“ä¹è§‚é” + æ¡ä»¶æ›´æ–° -->
<update id="deductPointsWithCheck">
    UPDATE user_points_balance
    SET total_points = total_points - #{points},
        update_time = NOW()
    WHERE user_id = #{userId}
      AND total_points &gt;= #{points}
      -- ä¹è§‚é”ï¼Œé˜²æ­¢å¹¶å‘é—®é¢˜
      AND update_time = #{expectedUpdateTime}
</update>
```

```java
@Transactional
public void deductPoints(Long userId, Integer points) {
    UserPointsBalance balance = pointsBalanceMapper.selectByUserId(userId);
    
    if (balance == null || balance.getTotalPoints() < points) {
        throw new BusinessException("ç§¯åˆ†ä¸è¶³");
    }
    
    // å¸¦ç‰ˆæœ¬å·çš„æ›´æ–°
    int updated = pointsBalanceMapper.deductPointsWithCheck(
        userId, points, balance.getUpdateTime()
    );
    
    if (updated == 0) {
        // æ›´æ–°å¤±è´¥ï¼Œå¯èƒ½æ˜¯å¹¶å‘å†²çª
        throw new BusinessException("ç§¯åˆ†æ‰£å‡å¤±è´¥ï¼Œè¯·é‡è¯•");
    }
}
```

#### 2.2 äº‹åŠ¡è¡¥å¿æœºåˆ¶

```java
@Service
public class LotteryTransactionService {
    
    /**
     * æŠ½å¥–äº‹åŠ¡è¡¥å¿
     */
    public void compensateLottery(Long userId, Long lotteryRecordId) {
        LotteryRecord record = lotteryRecordMapper.selectById(lotteryRecordId);
        
        if (record.getStatus() == LotteryStatus.FAILED) {
            // é€€å›ç§¯åˆ†
            pointsBalanceMapper.addPoints(userId, LOTTERY_COST);
            
            // æ›´æ–°è®°å½•çŠ¶æ€
            record.setStatus(LotteryStatus.COMPENSATED);
            lotteryRecordMapper.updateById(record);
            
            log.warn("æŠ½å¥–äº‹åŠ¡è¡¥å¿ï¼šç”¨æˆ·{}ï¼Œè®°å½•{}ï¼Œé€€å›{}ç§¯åˆ†", 
                userId, lotteryRecordId, LOTTERY_COST);
        }
    }
}
```

### 3. é«˜å¹¶å‘ä¼˜åŒ–ç­–ç•¥

#### 3.1 Redisç¼“å­˜é¢„çƒ­

```java
@Component
public class LotteryCacheWarmer {
    
    /**
     * ç³»ç»Ÿå¯åŠ¨æ—¶é¢„çƒ­å¥–æ± é…ç½®
     */
    @PostConstruct
    public void warmUpPrizePool() {
        List<LotteryPrize> prizes = lotteryPrizeMapper.selectAllActive();
        
        for (LotteryPrize prize : prizes) {
            // ç¼“å­˜å¥–å“é…ç½®
            String prizeKey = "lottery:prize:config:" + prize.getId();
            redisTemplate.opsForValue().set(prizeKey, prize, 1, TimeUnit.HOURS);
            
            // ç¼“å­˜å¥–å“åº“å­˜
            String stockKey = "lottery:prize:stock:" + prize.getId();
            redisTemplate.opsForValue().set(stockKey, prize.getStock());
        }
        
        // ç¼“å­˜æ¦‚ç‡è¡¨
        redisTemplate.opsForValue().set("lottery:probability:config", prizes);
        
        log.info("å¥–æ± é…ç½®é¢„çƒ­å®Œæˆï¼Œå¥–å“æ•°é‡ï¼š{}", prizes.size());
    }
}
```

#### 3.2 é™æµç­–ç•¥

```java
@RestController
public class LotteryController {
    
    /**
     * ç”¨æˆ·çº§é™æµï¼šæ¯åˆ†é’Ÿæœ€å¤š10æ¬¡æŠ½å¥–
     * å…¨å±€é™æµï¼šæ¯ç§’æœ€å¤š1000æ¬¡æŠ½å¥–
     */
    @RateLimiter(key = "lottery:draw", rate = 10, per = 60, scope = RateLimiterScope.USER)
    @GlobalRateLimiter(rate = 1000, per = 1)
    @PostMapping("/lottery/draw")
    public Result<LotteryResult> drawLottery() {
        Long userId = StpUtil.getLoginIdAsLong();
        return Result.success(lotteryService.drawLottery(userId));
    }
}
```

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. æŠ½å¥–å¥–å“é…ç½®è¡¨ï¼ˆlottery_prize_configï¼‰

```sql
CREATE TABLE lottery_prize_config (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'å¥–å“ID',
    prize_name VARCHAR(50) NOT NULL COMMENT 'å¥–å“åç§°',
    prize_level TINYINT NOT NULL COMMENT 'å¥–å“ç­‰çº§ï¼š1-ç‰¹ç­‰å¥– 2-ä¸€ç­‰å¥– ... 8-æœªä¸­å¥–',
    prize_points INT NOT NULL COMMENT 'å¥–åŠ±ç§¯åˆ†',
    base_probability DECIMAL(10, 8) NOT NULL COMMENT 'åŸºç¡€ä¸­å¥–æ¦‚ç‡ï¼ˆ0-1ä¹‹é—´ï¼‰',
    current_probability DECIMAL(10, 8) NOT NULL COMMENT 'å½“å‰åŠ¨æ€æ¦‚ç‡ï¼ˆ0-1ä¹‹é—´ï¼‰',
    target_return_rate DECIMAL(6, 4) DEFAULT 0.0100 COMMENT 'ç›®æ ‡å›æŠ¥ç‡ï¼ˆå¦‚0.0100=1%ï¼‰',
    max_return_rate DECIMAL(6, 4) DEFAULT 0.0150 COMMENT 'æœ€å¤§å›æŠ¥ç‡é˜ˆå€¼ï¼ˆå¦‚0.0150=1.5%ï¼‰',
    min_return_rate DECIMAL(6, 4) DEFAULT 0.0050 COMMENT 'æœ€å°å›æŠ¥ç‡é˜ˆå€¼ï¼ˆå¦‚0.0050=0.5%ï¼‰',
    actual_return_rate DECIMAL(6, 4) DEFAULT 0 COMMENT 'å®é™…å›æŠ¥ç‡',
    total_draw_count INT DEFAULT 0 COMMENT 'æ€»æŠ½å¥–æ¬¡æ•°ï¼ˆä½œä¸ºåˆ†æ¯ï¼‰',
    total_win_count INT DEFAULT 0 COMMENT 'æ€»ä¸­å¥–æ¬¡æ•°',
    today_draw_count INT DEFAULT 0 COMMENT 'ä»Šæ—¥æŠ½å¥–æ¬¡æ•°',
    today_win_count INT DEFAULT 0 COMMENT 'ä»Šæ—¥ä¸­å¥–æ¬¡æ•°',
    daily_stock INT DEFAULT -1 COMMENT 'æ¯æ—¥åº“å­˜ï¼ˆ-1è¡¨ç¤ºæ— é™åˆ¶ï¼‰',
    total_stock INT DEFAULT -1 COMMENT 'æ€»åº“å­˜ï¼ˆ-1è¡¨ç¤ºæ— é™åˆ¶ï¼‰',
    current_stock INT DEFAULT 0 COMMENT 'å½“å‰å‰©ä½™åº“å­˜',
    display_order INT DEFAULT 0 COMMENT 'æ˜¾ç¤ºé¡ºåº',
    prize_icon VARCHAR(255) COMMENT 'å¥–å“å›¾æ ‡',
    prize_desc VARCHAR(500) COMMENT 'å¥–å“æè¿°',
    is_active TINYINT DEFAULT 1 COMMENT 'æ˜¯å¦å¯ç”¨ï¼š0-ç¦ç”¨ 1-å¯ç”¨',
    is_suspended TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦æš‚åœï¼š0-æ­£å¸¸ 1-æš‚åœï¼ˆå›æŠ¥ç‡è¶…æ ‡ï¼‰',
    suspend_reason VARCHAR(255) COMMENT 'æš‚åœåŸå› ',
    suspend_until DATETIME COMMENT 'æš‚åœè‡³æŸæ—¶é—´',
    adjust_strategy VARCHAR(50) DEFAULT 'AUTO' COMMENT 'è°ƒæ•´ç­–ç•¥ï¼šAUTO-è‡ªåŠ¨ MANUAL-æ‰‹åŠ¨ FIXED-å›ºå®š',
    last_adjust_time DATETIME COMMENT 'æœ€åè°ƒæ•´æ—¶é—´',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    INDEX idx_active (is_active),
    INDEX idx_level (prize_level),
    INDEX idx_probability (current_probability DESC),
    INDEX idx_return_rate (actual_return_rate DESC),
    INDEX idx_suspended (is_suspended)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT 'æŠ½å¥–å¥–å“é…ç½®è¡¨';
```

### 2. æŠ½å¥–è®°å½•è¡¨ï¼ˆlottery_draw_recordï¼‰

```sql
CREATE TABLE lottery_draw_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'è®°å½•ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    prize_id BIGINT NOT NULL COMMENT 'å¥–å“ID',
    prize_level TINYINT NOT NULL COMMENT 'å¥–å“ç­‰çº§',
    prize_points INT NOT NULL COMMENT 'è·å¾—ç§¯åˆ†',
    cost_points INT NOT NULL COMMENT 'æ¶ˆè€—ç§¯åˆ†',
    actual_probability DECIMAL(10, 8) COMMENT 'å®é™…ä¸­å¥–æ¦‚ç‡',
    draw_ip VARCHAR(50) COMMENT 'æŠ½å¥–IP',
    draw_device VARCHAR(100) COMMENT 'æŠ½å¥–è®¾å¤‡',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1-æˆåŠŸ 2-å¤±è´¥ 3-å·²è¡¥å¿',
    points_detail_id BIGINT COMMENT 'ç§¯åˆ†æ˜ç»†IDï¼ˆæ‰£å‡ï¼‰',
    reward_detail_id BIGINT COMMENT 'ç§¯åˆ†æ˜ç»†IDï¼ˆå¥–åŠ±ï¼‰',
    remark VARCHAR(255) COMMENT 'å¤‡æ³¨',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'æŠ½å¥–æ—¶é—´',
    
    INDEX idx_user_id (user_id),
    INDEX idx_create_time (create_time DESC),
    INDEX idx_user_time (user_id, create_time DESC),
    INDEX idx_prize_level (prize_level),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT 'æŠ½å¥–è®°å½•è¡¨';
```

### 3. æŠ½å¥–ç»Ÿè®¡è¡¨ï¼ˆlottery_statistics_dailyï¼‰

```sql
CREATE TABLE lottery_statistics_daily (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ç»Ÿè®¡ID',
    stat_date DATE NOT NULL COMMENT 'ç»Ÿè®¡æ—¥æœŸ',
    total_draw_count INT DEFAULT 0 COMMENT 'æ€»æŠ½å¥–æ¬¡æ•°',
    total_cost_points BIGINT DEFAULT 0 COMMENT 'æ€»æ¶ˆè€—ç§¯åˆ†',
    total_reward_points BIGINT DEFAULT 0 COMMENT 'æ€»å¥–åŠ±ç§¯åˆ†',
    actual_return_rate DECIMAL(5, 2) COMMENT 'å®é™…å›æŠ¥ç‡ï¼ˆ%ï¼‰',
    profit_points BIGINT DEFAULT 0 COMMENT 'å¹³å°åˆ©æ¶¦ç§¯åˆ†',
    unique_user_count INT DEFAULT 0 COMMENT 'å‚ä¸ç”¨æˆ·æ•°',
    special_prize_count INT DEFAULT 0 COMMENT 'ç‰¹ç­‰å¥–ä¸­å¥–æ¬¡æ•°',
    first_prize_count INT DEFAULT 0 COMMENT 'ä¸€ç­‰å¥–ä¸­å¥–æ¬¡æ•°',
    second_prize_count INT DEFAULT 0 COMMENT 'äºŒç­‰å¥–ä¸­å¥–æ¬¡æ•°',
    third_prize_count INT DEFAULT 0 COMMENT 'ä¸‰ç­‰å¥–ä¸­å¥–æ¬¡æ•°',
    fourth_prize_count INT DEFAULT 0 COMMENT 'å››ç­‰å¥–ä¸­å¥–æ¬¡æ•°',
    fifth_prize_count INT DEFAULT 0 COMMENT 'äº”ç­‰å¥–ä¸­å¥–æ¬¡æ•°',
    sixth_prize_count INT DEFAULT 0 COMMENT 'å…­ç­‰å¥–ä¸­å¥–æ¬¡æ•°',
    no_prize_count INT DEFAULT 0 COMMENT 'æœªä¸­å¥–æ¬¡æ•°',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    UNIQUE KEY uk_stat_date (stat_date),
    INDEX idx_create_time (create_time DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT 'æŠ½å¥–æ¯æ—¥ç»Ÿè®¡è¡¨';
```

### 4. ç”¨æˆ·æŠ½å¥–é™åˆ¶è¡¨ï¼ˆuser_lottery_limitï¼‰

```sql
CREATE TABLE user_lottery_limit (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    today_draw_count INT DEFAULT 0 COMMENT 'ä»Šæ—¥æŠ½å¥–æ¬¡æ•°',
    week_draw_count INT DEFAULT 0 COMMENT 'æœ¬å‘¨æŠ½å¥–æ¬¡æ•°',
    month_draw_count INT DEFAULT 0 COMMENT 'æœ¬æœˆæŠ½å¥–æ¬¡æ•°',
    total_draw_count INT DEFAULT 0 COMMENT 'æ€»æŠ½å¥–æ¬¡æ•°',
    today_win_count INT DEFAULT 0 COMMENT 'ä»Šæ—¥ä¸­å¥–æ¬¡æ•°',
    total_win_count INT DEFAULT 0 COMMENT 'æ€»ä¸­å¥–æ¬¡æ•°',
    max_continuous_no_win INT DEFAULT 0 COMMENT 'æœ€å¤§è¿ç»­æœªä¸­å¥–æ¬¡æ•°',
    current_continuous_no_win INT DEFAULT 0 COMMENT 'å½“å‰è¿ç»­æœªä¸­å¥–æ¬¡æ•°',
    last_draw_time DATETIME COMMENT 'æœ€åæŠ½å¥–æ—¶é—´',
    last_win_time DATETIME COMMENT 'æœ€åä¸­å¥–æ—¶é—´',
    is_blacklist TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦é»‘åå•ï¼š0-å¦ 1-æ˜¯',
    risk_level TINYINT DEFAULT 0 COMMENT 'é£é™©ç­‰çº§ï¼š0-æ­£å¸¸ 1-ä½é£é™© 2-ä¸­é£é™© 3-é«˜é£é™©',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    UNIQUE KEY uk_user_id (user_id),
    INDEX idx_blacklist (is_blacklist),
    INDEX idx_risk_level (risk_level)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT 'ç”¨æˆ·æŠ½å¥–é™åˆ¶è¡¨';
```

## ğŸš€ åŠŸèƒ½éœ€æ±‚

### 1. ç”¨æˆ·ç«¯åŠŸèƒ½

#### 1.1 æŠ½å¥–ç•Œé¢
- **ç§¯åˆ†æ˜¾ç¤º**: æ˜¾ç¤ºå½“å‰ç§¯åˆ†ä½™é¢
- **æŠ½å¥–æˆæœ¬**: æ˜ç¡®æ ‡æ³¨å•æ¬¡æŠ½å¥–æ¶ˆè€—100ç§¯åˆ†
- **å¥–å“å±•ç¤º**: è½¬ç›˜/ä¹å®«æ ¼å½¢å¼å±•ç¤ºæ‰€æœ‰å¥–å“
- **æŠ½å¥–åŠ¨ç”»**: ç‚«é…·çš„æŠ½å¥–åŠ¨ç”»æ•ˆæœ
- **ä¸­å¥–æç¤º**: ä¸­å¥–åå¼¹çª—æ˜¾ç¤ºå¥–å“å’Œç§¯åˆ†
- **å‰©ä½™æ¬¡æ•°**: æ˜¾ç¤ºä»Šæ—¥å‰©ä½™æŠ½å¥–æ¬¡æ•°ï¼ˆå¦‚æœ‰é™åˆ¶ï¼‰

#### 1.2 æŠ½å¥–è®°å½•
- **ä¸ªäººè®°å½•**: æŸ¥çœ‹ä¸ªäººæŠ½å¥–å†å²è®°å½•
- **ä¸­å¥–æ˜ç»†**: æ˜¾ç¤ºæ¯æ¬¡æŠ½å¥–çš„ç»“æœå’Œè·å¾—ç§¯åˆ†
- **ç»Ÿè®¡ä¿¡æ¯**: æ€»æŠ½å¥–æ¬¡æ•°ã€ä¸­å¥–æ¬¡æ•°ã€è·å¾—æ€»ç§¯åˆ†
- **æ—¥æœŸç­›é€‰**: æŒ‰æ—¥æœŸèŒƒå›´ç­›é€‰æŠ½å¥–è®°å½•

#### 1.3 æŠ½å¥–è§„åˆ™
- **è§„åˆ™è¯´æ˜**: è¯¦ç»†çš„æŠ½å¥–è§„åˆ™å’Œå¥–å“è¯´æ˜
- **æ¦‚ç‡å…¬ç¤º**: å…¬å¼€å±•ç¤ºå„å¥–é¡¹çš„ä¸­å¥–æ¦‚ç‡
- **è´¹ç”¨è¯´æ˜**: æ˜ç¡®æŠ½å¥–æˆæœ¬å’Œå¥–å“ä»·å€¼
- **æ³¨æ„äº‹é¡¹**: ç”¨æˆ·é¡»çŸ¥å’Œé£é™©æç¤º

### 2. ç®¡ç†ç«¯åŠŸèƒ½

#### 2.1 å¥–å“é…ç½®ç®¡ç†

**åŸºç¡€é…ç½®ï¼š**
- **å¥–å“ç®¡ç†**: å¢åˆ æ”¹æŸ¥å¥–å“é…ç½®
- **æ¦‚ç‡è®¾ç½®**: è®¾ç½®å„å¥–é¡¹çš„åŸºç¡€æ¦‚ç‡å’Œå½“å‰æ¦‚ç‡
- **åº“å­˜ç®¡ç†**: è®¾ç½®å’Œç›‘æ§å¥–å“åº“å­˜ï¼ˆæ¯æ—¥åº“å­˜ã€æ€»åº“å­˜ï¼‰
- **å¯ç”¨çŠ¶æ€**: å¯ç”¨æˆ–ç¦ç”¨ç‰¹å®šå¥–å“

**å›æŠ¥ç‡æ§åˆ¶ï¼ˆæ–°å¢ï¼‰ï¼š**
- **ç›®æ ‡å›æŠ¥ç‡è®¾ç½®**: ä¸ºæ¯ä¸ªå¥–å“å•ç‹¬è®¾ç½®ç›®æ ‡å›æŠ¥ç‡ï¼ˆå¦‚ç‰¹ç­‰å¥–ç›®æ ‡0.1%ï¼‰
- **å›æŠ¥ç‡é˜ˆå€¼**: è®¾ç½®æœ€å¤§å’Œæœ€å°å›æŠ¥ç‡é˜ˆå€¼ï¼Œè§¦å‘è‡ªåŠ¨è°ƒæ•´
- **å›æŠ¥ç‡ç›‘æ§**: å®æ—¶æ˜¾ç¤ºæ¯ä¸ªå¥–å“çš„å®é™…å›æŠ¥ç‡
- **æ‰‹åŠ¨è°ƒæ•´æ¦‚ç‡**: è¿è¥äººå‘˜å¯æ‰‹åŠ¨è°ƒæ•´å¥–å“æ¦‚ç‡
- **æ‰¹é‡è°ƒæ•´**: æ‰¹é‡è°ƒæ•´å¤šä¸ªå¥–å“çš„æ¦‚ç‡å’Œå›æŠ¥ç‡é…ç½®

**åŠ¨æ€è°ƒæ•´ç­–ç•¥ï¼ˆæ–°å¢ï¼‰ï¼š**
- **è°ƒæ•´æ¨¡å¼é€‰æ‹©**:
  - `AUTO` - è‡ªåŠ¨è°ƒæ•´ï¼šç³»ç»Ÿè‡ªåŠ¨æ ¹æ®å›æŠ¥ç‡è°ƒæ•´æ¦‚ç‡
  - `MANUAL` - æ‰‹åŠ¨è°ƒæ•´ï¼šä»…æ”¯æŒæ‰‹åŠ¨ä¿®æ”¹ï¼Œä¸è‡ªåŠ¨è°ƒæ•´
  - `FIXED` - å›ºå®šæ¨¡å¼ï¼šæ¦‚ç‡å›ºå®šï¼Œä¸åšä»»ä½•è°ƒæ•´
- **è°ƒæ•´é¢‘ç‡è®¾ç½®**: è®¾ç½®è‡ªåŠ¨è°ƒæ•´çš„è§¦å‘é¢‘ç‡ï¼ˆæ¯Næ¬¡æŠ½å¥–ã€æ¯å°æ—¶ç­‰ï¼‰
- **è°ƒæ•´å¹…åº¦é™åˆ¶**: è®¾ç½®å•æ¬¡è°ƒæ•´çš„æœ€å¤§å¹…åº¦ï¼ˆå¦‚Â±10%ï¼‰
- **å†å²ç‰ˆæœ¬ç®¡ç†**: ä¿å­˜æ¦‚ç‡è°ƒæ•´å†å²ï¼Œæ”¯æŒå›æ»š

**å¥–å“æš‚åœæ§åˆ¶ï¼ˆæ–°å¢ï¼‰ï¼š**
- **è‡ªåŠ¨æš‚åœ**: å›æŠ¥ç‡è¶…æ ‡æ—¶è‡ªåŠ¨æš‚åœå¥–å“å‘æ”¾
- **æ‰‹åŠ¨æš‚åœ**: è¿è¥äººå‘˜æ‰‹åŠ¨æš‚åœæŸä¸ªå¥–å“
- **å®šæ—¶æ¢å¤**: è®¾ç½®æš‚åœæ—¶é•¿ï¼Œåˆ°æœŸè‡ªåŠ¨æ¢å¤
- **æš‚åœæé†’**: å¥–å“è¢«æš‚åœæ—¶ï¼Œç³»ç»Ÿé€šçŸ¥ç›¸å…³äººå‘˜

#### 2.2 å®æ—¶ç›‘æ§ä¸­å¿ƒï¼ˆå¢å¼ºï¼‰

**å…¨å±€ç›‘æ§ï¼š**
- **å®æ—¶å¤§ç›˜**: å®æ—¶æŸ¥çœ‹æŠ½å¥–æ•°æ®ï¼ˆQPSã€æˆåŠŸç‡ã€å›æŠ¥ç‡ï¼‰
- **ç»Ÿè®¡æŠ¥è¡¨**: æ¯æ—¥/æ¯å‘¨/æ¯æœˆæŠ½å¥–ç»Ÿè®¡
- **è¶‹åŠ¿å›¾è¡¨**: æŠ½å¥–é‡ã€å›æŠ¥ç‡ã€åˆ©æ¶¦è¶‹åŠ¿å›¾

**å•å“ç›‘æ§ï¼ˆæ–°å¢ï¼‰ï¼š**
- **å¥–å“çº§å›æŠ¥ç‡**: æ¯ä¸ªå¥–å“çš„å®æ—¶å›æŠ¥ç‡å’Œå†å²è¶‹åŠ¿
- **ä¸­å¥–åˆ†å¸ƒ**: å„å¥–å“çš„ä¸­å¥–æ¬¡æ•°å’Œåˆ†å¸ƒæƒ…å†µ
- **æ¦‚ç‡å˜åŒ–æ›²çº¿**: å±•ç¤ºæ¯ä¸ªå¥–å“æ¦‚ç‡çš„åŠ¨æ€å˜åŒ–
- **é¢„è­¦æç¤º**: å›æŠ¥ç‡æ¥è¿‘é˜ˆå€¼æ—¶é«˜äº®æé†’

**å¼‚å¸¸é¢„è­¦ï¼ˆå¢å¼ºï¼‰ï¼š**
- **å›æŠ¥ç‡é¢„è­¦**: 
  - å•å“å›æŠ¥ç‡è¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚>1.5%ï¼‰
  - å…¨å±€å›æŠ¥ç‡è¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚>90%ï¼‰
- **ä¸­å¥–å¼‚å¸¸é¢„è­¦**:
  - è¿ç»­Næ¬¡ç›¸åŒé«˜ä»·å€¼å¥–å“ä¸­å¥–
  - åŒä¸€ç”¨æˆ·é¢‘ç¹ä¸­é«˜ä»·å€¼å¥–å“
- **åº“å­˜é¢„è­¦**: å¥–å“åº“å­˜ä¸è¶³é¢„è­¦
- **ç³»ç»Ÿæ€§èƒ½é¢„è­¦**: QPSè¿‡é«˜ã€å“åº”å»¶è¿Ÿ

**è°ƒæ•´è®°å½•ï¼ˆæ–°å¢ï¼‰ï¼š**
- **è‡ªåŠ¨è°ƒæ•´æ—¥å¿—**: è®°å½•æ‰€æœ‰è‡ªåŠ¨æ¦‚ç‡è°ƒæ•´
- **æ‰‹åŠ¨æ“ä½œæ—¥å¿—**: è®°å½•ç®¡ç†å‘˜çš„æ‰‹åŠ¨è°ƒæ•´æ“ä½œ
- **è°ƒæ•´æ•ˆæœåˆ†æ**: è°ƒæ•´åçš„å›æŠ¥ç‡å˜åŒ–è¶‹åŠ¿

#### 2.3 ç­–ç•¥é…ç½®ç®¡ç†ï¼ˆæ–°å¢ï¼‰

**æŠ½å¥–ç­–ç•¥é€‰æ‹©ï¼š**
- **å…¨å±€ç­–ç•¥**: é…ç½®é»˜è®¤ä½¿ç”¨çš„æŠ½å¥–ç­–ç•¥ï¼ˆAlias Methodã€åŠ¨æ€æƒé‡ã€ä¿åº•ç­‰ï¼‰
- **ç”¨æˆ·åˆ†ç»„ç­–ç•¥**: ä¸ºä¸åŒç”¨æˆ·ç¾¤ä½“é…ç½®ä¸åŒç­–ç•¥ï¼ˆVIPã€æ™®é€šç”¨æˆ·ï¼‰
- **ç­–ç•¥å‚æ•°é…ç½®**: é…ç½®å„ç­–ç•¥çš„å…·ä½“å‚æ•°ï¼ˆå¦‚ä¿åº•æ¬¡æ•°ã€æƒé‡å› å­ï¼‰

**é£æ§ç­–ç•¥é…ç½®ï¼š**
- **é™æµé…ç½®**: é…ç½®ç”¨æˆ·çº§ã€IPçº§ã€å…¨å±€é™æµå‚æ•°
- **å†·å´æ—¶é—´**: é…ç½®æŠ½å¥–å†·å´æ—¶é—´
- **é»‘åå•è§„åˆ™**: é…ç½®è‡ªåŠ¨åŠ å…¥é»‘åå•çš„è§„åˆ™

**ABæµ‹è¯•ï¼ˆæ–°å¢ï¼‰ï¼š**
- **ç­–ç•¥å¯¹æ¯”æµ‹è¯•**: åŒæ—¶è¿è¡Œå¤šä¸ªç­–ç•¥ï¼Œå¯¹æ¯”æ•ˆæœ
- **æ¦‚ç‡æ–¹æ¡ˆæµ‹è¯•**: æµ‹è¯•ä¸åŒçš„æ¦‚ç‡é…ç½®æ–¹æ¡ˆ
- **æ•°æ®å¯¹æ¯”åˆ†æ**: å¯¹æ¯”ä¸åŒæ–¹æ¡ˆçš„å›æŠ¥ç‡ã€ç”¨æˆ·æ»¡æ„åº¦

#### 2.4 ç”¨æˆ·ç®¡ç†
- **é»‘åå•ç®¡ç†**: æ·»åŠ /ç§»é™¤æŠ½å¥–é»‘åå•ç”¨æˆ·
- **é£é™©ç”¨æˆ·**: æŸ¥çœ‹é«˜é£é™©ç”¨æˆ·åˆ—è¡¨
- **é™åˆ¶è®¾ç½®**: è®¾ç½®ç”¨æˆ·æŠ½å¥–æ¬¡æ•°é™åˆ¶
- **è®°å½•æŸ¥è¯¢**: æŸ¥è¯¢ä»»æ„ç”¨æˆ·çš„æŠ½å¥–è®°å½•
- **ç”¨æˆ·ç”»åƒ**: åˆ†æç”¨æˆ·æŠ½å¥–è¡Œä¸ºå’Œä¸­å¥–æƒ…å†µ

#### 2.5 æ•°æ®åˆ†æï¼ˆå¢å¼ºï¼‰
- **æ”¶ç›Šåˆ†æ**: å¹³å°ç§¯åˆ†æ”¶ç›Šç»Ÿè®¡ï¼Œå•å“æ”¶ç›Šåˆ†æ
- **ç”¨æˆ·åˆ†æ**: æŠ½å¥–ç”¨æˆ·è¡Œä¸ºåˆ†æï¼Œç•™å­˜åˆ†æ
- **è¶‹åŠ¿åˆ†æ**: æŠ½å¥–è¶‹åŠ¿å’Œçƒ­åº¦åˆ†æ
- **å¥–å“åˆ†æ**: å„å¥–å“ä¸­å¥–åˆ†å¸ƒã€å›æŠ¥ç‡åˆ†æ
- **ROIåˆ†æ**: æŠ•å…¥äº§å‡ºæ¯”åˆ†æï¼Œæˆæœ¬æ•ˆç›Šåˆ†æ

## ğŸ” é˜²åˆ·æœºåˆ¶

### 1. åŸºç¡€é˜²åˆ·ç­–ç•¥

#### 1.1 é¢‘ç‡é™åˆ¶
```java
public class LotteryRateLimiter {
    /**
     * ç”¨æˆ·çº§é™åˆ¶
     */
    - æ¯åˆ†é’Ÿæœ€å¤š10æ¬¡æŠ½å¥–
    - æ¯å°æ—¶æœ€å¤š100æ¬¡æŠ½å¥–
    - æ¯å¤©æœ€å¤š500æ¬¡æŠ½å¥–ï¼ˆå¯é…ç½®ï¼‰
    
    /**
     * IPçº§é™åˆ¶
     */
    - åŒä¸€IPæ¯åˆ†é’Ÿæœ€å¤š50æ¬¡æŠ½å¥–
    - åŒä¸€IPæ¯å¤©æœ€å¤š1000æ¬¡æŠ½å¥–
    
    /**
     * è®¾å¤‡çº§é™åˆ¶
     */
    - åŒä¸€è®¾å¤‡æ¯å¤©æœ€å¤š300æ¬¡æŠ½å¥–
}
```

#### 1.2 å†·å´æ—¶é—´
- **æ™®é€šç”¨æˆ·**: ä¸¤æ¬¡æŠ½å¥–é—´éš”ä¸å°‘äº3ç§’
- **é¢‘ç¹ç”¨æˆ·**: è¿ç»­æŠ½å¥–10æ¬¡åï¼Œå¼ºåˆ¶å†·å´60ç§’
- **é«˜é£é™©ç”¨æˆ·**: æ¯æ¬¡æŠ½å¥–åå†·å´10ç§’

#### 1.3 è¡Œä¸ºæ£€æµ‹
```java
public class AntiFraudDetector {
    /**
     * å¼‚å¸¸è¡Œä¸ºæ£€æµ‹
     */
    public boolean detectAbnormal(Long userId) {
        // 1. æ£€æµ‹æŠ½å¥–æ—¶é—´è§„å¾‹ï¼ˆæœºå™¨äººç‰¹å¾ï¼‰
        if (hasRegularPattern(userId)) {
            return true;
        }
        
        // 2. æ£€æµ‹IPå’Œè®¾å¤‡åˆ‡æ¢é¢‘ç‡
        if (frequentDeviceSwitch(userId)) {
            return true;
        }
        
        // 3. æ£€æµ‹ç§¯åˆ†æ¥æºå¼‚å¸¸
        if (abnormalPointsSource(userId)) {
            return true;
        }
        
        // 4. æ£€æµ‹ä¸­å¥–ç‡å¼‚å¸¸
        if (abnormalWinRate(userId)) {
            return true;
        }
        
        return false;
    }
}
```

### 2. é£é™©ç­‰çº§ç®¡ç†

#### 2.1 é£é™©è¯„çº§è§„åˆ™
- **æ­£å¸¸ç”¨æˆ·**: æ­£å¸¸æŠ½å¥–è¡Œä¸ºï¼Œæ— å¼‚å¸¸
- **ä½é£é™©**: æŠ½å¥–é¢‘ç‡ç•¥é«˜ï¼Œä½†è¡Œä¸ºæ­£å¸¸
- **ä¸­é£é™©**: å­˜åœ¨å¯ç–‘è¡Œä¸ºï¼Œéœ€è¦ç›‘æ§
- **é«˜é£é™©**: æ˜æ˜¾å¼‚å¸¸è¡Œä¸ºï¼Œé™åˆ¶æŠ½å¥–

#### 2.2 è‡ªåŠ¨é£æ§æªæ–½
```java
public class AutoRiskControl {
    public void handleRiskUser(Long userId, RiskLevel level) {
        switch (level) {
            case LOW:
                // æ­£å¸¸æ”¾è¡Œï¼Œè®°å½•æ—¥å¿—
                logRiskBehavior(userId, level);
                break;
            case MEDIUM:
                // å¢åŠ å†·å´æ—¶é—´ï¼Œé™ä½ä¸­å¥–æ¦‚ç‡
                increaseCooldown(userId, 30);
                adjustWinProbability(userId, 0.5);
                break;
            case HIGH:
                // é™åˆ¶æŠ½å¥–æ¬¡æ•°ï¼Œäººå·¥å®¡æ ¸
                restrictDailyLimit(userId, 10);
                notifyAdminReview(userId);
                break;
            case BLACKLIST:
                // ç¦æ­¢æŠ½å¥–
                throw new BusinessException("æ‚¨çš„è´¦å·å­˜åœ¨å¼‚å¸¸ï¼Œå·²è¢«é™åˆ¶æŠ½å¥–");
        }
    }
}
```

## ğŸ“± æ¥å£è®¾è®¡

### 1. ç”¨æˆ·ç«¯æ¥å£ï¼ˆ/user/lotteryï¼‰

```
POST /user/lottery/draw                    # æŠ½å¥–
POST /user/lottery/record                  # æŠ½å¥–è®°å½•
GET /user/lottery/statistics               # ä¸ªäººæŠ½å¥–ç»Ÿè®¡
GET /user/lottery/prizes                   # è·å–å¥–å“åˆ—è¡¨
GET /user/lottery/rules                    # è·å–æŠ½å¥–è§„åˆ™
GET /user/lottery/check-limit              # æ£€æŸ¥æŠ½å¥–é™åˆ¶
```

### 2. ç®¡ç†ç«¯æ¥å£ï¼ˆ/admin/lotteryï¼‰

**å¥–å“é…ç½®æ¥å£ï¼š**
```
POST /admin/lottery/prize/save             # ä¿å­˜å¥–å“é…ç½®
POST /admin/lottery/prize/list             # å¥–å“åˆ—è¡¨
POST /admin/lottery/prize/delete           # åˆ é™¤å¥–å“
POST /admin/lottery/prize/toggle           # å¯ç”¨/ç¦ç”¨å¥–å“
POST /admin/lottery/prize/suspend          # æš‚åœ/æ¢å¤å¥–å“ï¼ˆæ–°å¢ï¼‰
POST /admin/lottery/prize/adjust-probability  # æ‰‹åŠ¨è°ƒæ•´æ¦‚ç‡ï¼ˆæ–°å¢ï¼‰
POST /admin/lottery/prize/batch-adjust     # æ‰¹é‡è°ƒæ•´æ¦‚ç‡ï¼ˆæ–°å¢ï¼‰
POST /admin/lottery/prize/return-rate      # è·å–å¥–å“å›æŠ¥ç‡è¯¦æƒ…ï¼ˆæ–°å¢ï¼‰
POST /admin/lottery/prize/adjust-history   # è·å–è°ƒæ•´å†å²ï¼ˆæ–°å¢ï¼‰
```

**ç›‘æ§ä¸ç»Ÿè®¡æ¥å£ï¼š**
```
POST /admin/lottery/record/list            # æŠ½å¥–è®°å½•åˆ—è¡¨
POST /admin/lottery/statistics/daily       # æ¯æ—¥ç»Ÿè®¡
POST /admin/lottery/statistics/summary     # æ±‡æ€»ç»Ÿè®¡
GET /admin/lottery/monitor/realtime        # å®æ—¶ç›‘æ§æ•°æ®
GET /admin/lottery/monitor/prize-detail    # å•å“ç›‘æ§è¯¦æƒ…ï¼ˆæ–°å¢ï¼‰
GET /admin/lottery/monitor/return-rate-trend # å›æŠ¥ç‡è¶‹åŠ¿ï¼ˆæ–°å¢ï¼‰
GET /admin/lottery/monitor/alerts          # é¢„è­¦ä¿¡æ¯åˆ—è¡¨ï¼ˆæ–°å¢ï¼‰
```

**ç­–ç•¥é…ç½®æ¥å£ï¼ˆæ–°å¢ï¼‰ï¼š**
```
POST /admin/lottery/strategy/save          # ä¿å­˜ç­–ç•¥é…ç½®
POST /admin/lottery/strategy/list          # è·å–ç­–ç•¥åˆ—è¡¨
POST /admin/lottery/strategy/switch        # åˆ‡æ¢æŠ½å¥–ç­–ç•¥
POST /admin/lottery/strategy/test          # ABæµ‹è¯•é…ç½®
```

**é£æ§ç®¡ç†æ¥å£ï¼š**
```
POST /admin/lottery/user/blacklist         # é»‘åå•ç®¡ç†
POST /admin/lottery/user/risk-list         # é£é™©ç”¨æˆ·åˆ—è¡¨
POST /admin/lottery/risk/rules             # é£æ§è§„åˆ™é…ç½®ï¼ˆæ–°å¢ï¼‰
```

**æ•°æ®åˆ†ææ¥å£ï¼ˆæ–°å¢ï¼‰ï¼š**
```
POST /admin/lottery/analysis/prize-roi     # å¥–å“ROIåˆ†æ
POST /admin/lottery/analysis/user-behavior # ç”¨æˆ·è¡Œä¸ºåˆ†æ
POST /admin/lottery/analysis/cost-benefit  # æˆæœ¬æ•ˆç›Šåˆ†æ
```

### 3. æ¥å£ç¤ºä¾‹

#### 3.1 ç”¨æˆ·æŠ½å¥–ï¼ˆä¿æŒä¸å˜ï¼‰
```json
// è¯·æ±‚
POST /user/lottery/draw

// å“åº” - æˆåŠŸä¸­å¥–
{
    "code": 200,
    "message": "æŠ½å¥–æˆåŠŸ",
    "data": {
        "recordId": 123456,
        "prizeId": 3,
        "prizeName": "äºŒç­‰å¥–",
        "prizeLevel": 3,
        "prizePoints": 200,
        "costPoints": 100,
        "netProfit": 100,
        "currentBalance": 1850,
        "todayDrawCount": 5,
        "todayWinCount": 2,
        "isWin": true,
        "congratulations": "æ­å–œæ‚¨è·å¾—äºŒç­‰å¥–ï¼Œ200ç§¯åˆ†å·²åˆ°è´¦ï¼"
    }
}

// å“åº” - æœªä¸­å¥–
{
    "code": 200,
    "message": "æŠ½å¥–æˆåŠŸ",
    "data": {
        "recordId": 123457,
        "prizeId": 8,
        "prizeName": "æœªä¸­å¥–",
        "prizeLevel": 8,
        "prizePoints": 0,
        "costPoints": 100,
        "netProfit": -100,
        "currentBalance": 1750,
        "todayDrawCount": 6,
        "todayWinCount": 2,
        "isWin": false,
        "encouragement": "å¾ˆé—æ†¾ï¼Œå†è¯•ä¸€æ¬¡å§ï¼"
    }
}
```

#### 3.2 è·å–å¥–å“åˆ—è¡¨
```json
// è¯·æ±‚
GET /user/lottery/prizes

// å“åº”
{
    "code": 200,
    "message": "è·å–æˆåŠŸ",
    "data": {
        "drawCost": 100,
        "prizes": [
            {
                "prizeId": 1,
                "prizeName": "ç‰¹ç­‰å¥–",
                "prizeLevel": 1,
                "prizePoints": 1000,
                "probability": 0.001,
                "probabilityDisplay": "0.1%",
                "prizeIcon": "/images/prize_special.png",
                "displayOrder": 1
            },
            {
                "prizeId": 2,
                "prizeName": "ä¸€ç­‰å¥–",
                "prizeLevel": 2,
                "prizePoints": 500,
                "probability": 0.005,
                "probabilityDisplay": "0.5%",
                "prizeIcon": "/images/prize_first.png",
                "displayOrder": 2
            }
            // ... å…¶ä»–å¥–å“
        ],
        "totalProbability": 1.0,
        "expectedReturn": 75,
        "expectedReturnRate": "75%"
    }
}
```

#### 3.3 ç®¡ç†ç«¯ - æ‰‹åŠ¨è°ƒæ•´å¥–å“æ¦‚ç‡ï¼ˆæ–°å¢ï¼‰
```json
// è¯·æ±‚
POST /admin/lottery/prize/adjust-probability
{
    "prizeId": 1,
    "newProbability": 0.0008,
    "adjustReason": "ç‰¹ç­‰å¥–å›æŠ¥ç‡è¿‡é«˜ï¼Œä»0.1%é™è‡³0.08%",
    "adjustMode": "MANUAL",
    "effectiveImmediately": true
}

// å“åº”
{
    "code": 200,
    "message": "æ¦‚ç‡è°ƒæ•´æˆåŠŸ",
    "data": {
        "prizeId": 1,
        "prizeName": "ç‰¹ç­‰å¥–",
        "oldProbability": 0.001,
        "newProbability": 0.0008,
        "oldReturnRate": 0.0152,
        "expectedReturnRate": 0.0122,
        "adjustTime": "2025-10-04 15:30:00",
        "operator": "admin",
        "needReNormalize": true,
        "affectedPrizes": [
            {
                "prizeId": 8,
                "prizeName": "æœªä¸­å¥–",
                "probabilityChange": 0.0002,
                "newProbability": 0.126
            }
        ]
    }
}
```

#### 3.4 ç®¡ç†ç«¯ - è·å–å¥–å“å›æŠ¥ç‡è¯¦æƒ…ï¼ˆæ–°å¢ï¼‰
```json
// è¯·æ±‚
GET /admin/lottery/monitor/prize-detail?prizeId=1

// å“åº”
{
    "code": 200,
    "message": "è·å–æˆåŠŸ",
    "data": {
        "prizeId": 1,
        "prizeName": "ç‰¹ç­‰å¥–",
        "prizePoints": 1000,
        "baseProbability": 0.001,
        "currentProbability": 0.0008,
        "targetReturnRate": 0.01,
        "maxReturnRate": 0.015,
        "minReturnRate": 0.005,
        "actualReturnRate": 0.0122,
        "status": "SUSPENDED",
        "suspendReason": "å›æŠ¥ç‡è¶…è¿‡æœ€å¤§é˜ˆå€¼",
        "suspendUntil": "2025-10-04 16:30:00",
        "statistics": {
            "totalDrawCount": 15800,
            "totalWinCount": 16,
            "todayDrawCount": 2340,
            "todayWinCount": 3,
            "weekDrawCount": 10500,
            "weekWinCount": 11,
            "averageWinInterval": 987.5,
            "lastWinTime": "2025-10-04 14:55:23"
        },
        "trend": {
            "returnRateHistory": [
                {"date": "2025-10-01", "rate": 0.0095},
                {"date": "2025-10-02", "rate": 0.0108},
                {"date": "2025-10-03", "rate": 0.0132},
                {"date": "2025-10-04", "rate": 0.0155}
            ],
            "probabilityHistory": [
                {"time": "2025-10-01 00:00", "probability": 0.001},
                {"time": "2025-10-03 12:00", "probability": 0.0009},
                {"time": "2025-10-04 10:00", "probability": 0.0008}
            ]
        },
        "adjustHistory": [
            {
                "adjustTime": "2025-10-04 10:00:00",
                "adjustType": "AUTO",
                "oldProbability": 0.0009,
                "newProbability": 0.0008,
                "reason": "å›æŠ¥ç‡è¾¾åˆ°1.45%ï¼Œè‡ªåŠ¨é™ä½æ¦‚ç‡",
                "operator": "SYSTEM"
            },
            {
                "adjustTime": "2025-10-03 12:00:00",
                "adjustType": "MANUAL",
                "oldProbability": 0.001,
                "newProbability": 0.0009,
                "reason": "è¿è¥è°ƒæ•´",
                "operator": "admin"
            }
        ],
        "recommendation": {
            "suggestAction": "KEEP_SUSPENDED",
            "suggestProbability": 0.0007,
            "reason": "å½“å‰å›æŠ¥ç‡1.22%ä»é«˜äºç›®æ ‡1%ï¼Œå»ºè®®ç»§ç»­æš‚åœæˆ–é™ä½è‡³0.07%"
        }
    }
}
```

#### 3.5 ç®¡ç†ç«¯ - å®æ—¶ç›‘æ§å¤§ç›˜ï¼ˆå¢å¼ºï¼‰
```json
// è¯·æ±‚
GET /admin/lottery/monitor/realtime

// å“åº”
{
    "code": 200,
    "message": "è·å–æˆåŠŸ",
    "data": {
        "timestamp": "2025-10-04 15:30:00",
        "systemStatus": {
            "status": "NORMAL",
            "qps": 856,
            "avgResponseTime": 125,
            "successRate": 99.98,
            "activeUsers": 1234
        },
        "todayOverview": {
            "totalDrawCount": 25680,
            "totalCostPoints": 2568000,
            "totalRewardPoints": 1926000,
            "actualReturnRate": 75.0,
            "profitPoints": 642000,
            "profitRate": 25.0,
            "uniqueUserCount": 3456
        },
        "prizeStatus": [
            {
                "prizeId": 1,
                "prizeName": "ç‰¹ç­‰å¥–",
                "currentProbability": 0.0008,
                "actualReturnRate": 0.0122,
                "status": "SUSPENDED",
                "todayWinCount": 3,
                "alertLevel": "HIGH",
                "alertMessage": "å›æŠ¥ç‡è¶…æ ‡ï¼Œå·²æš‚åœ"
            },
            {
                "prizeId": 2,
                "prizeName": "ä¸€ç­‰å¥–",
                "currentProbability": 0.005,
                "actualReturnRate": 0.0251,
                "status": "NORMAL",
                "todayWinCount": 13,
                "alertLevel": "MEDIUM",
                "alertMessage": "å›æŠ¥ç‡ç•¥é«˜ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨è°ƒæ•´"
            },
            {
                "prizeId": 3,
                "prizeName": "äºŒç­‰å¥–",
                "currentProbability": 0.02,
                "actualReturnRate": 0.0398,
                "status": "NORMAL",
                "todayWinCount": 52,
                "alertLevel": "LOW",
                "alertMessage": null
            }
        ],
        "recentAlerts": [
            {
                "alertTime": "2025-10-04 14:55:23",
                "alertLevel": "HIGH",
                "alertType": "RETURN_RATE_EXCEED",
                "message": "ç‰¹ç­‰å¥–å›æŠ¥ç‡è¾¾åˆ°1.55%ï¼Œå·²è§¦å‘è‡ªåŠ¨æš‚åœ",
                "handled": true
            },
            {
                "alertTime": "2025-10-04 13:20:15",
                "alertLevel": "MEDIUM",
                "alertType": "CONTINUOUS_HIGH_PRIZE",
                "message": "è¿ç»­5æ¬¡ä¸€ç­‰å¥–ä¸­å¥–ï¼Œè¯·å…³æ³¨",
                "handled": false
            }
        ],
        "strategyInfo": {
            "currentStrategy": "ALIAS_METHOD",
            "lastAdjustTime": "2025-10-04 14:55:23",
            "nextAdjustTime": "2025-10-04 16:00:00",
            "autoAdjustEnabled": true
        }
    }
}
```

#### 3.6 ç®¡ç†ç«¯ç»Ÿè®¡æ•°æ®
```json
// è¯·æ±‚
POST /admin/lottery/statistics/daily
{
    "startDate": "2025-10-01",
    "endDate": "2025-10-07"
}

// å“åº”
{
    "code": 200,
    "message": "æŸ¥è¯¢æˆåŠŸ",
    "data": {
        "summary": {
            "totalDrawCount": 15800,
            "totalCostPoints": 1580000,
            "totalRewardPoints": 1185000,
            "actualReturnRate": 75.0,
            "profitPoints": 395000,
            "profitRate": 25.0,
            "uniqueUserCount": 2340
        },
        "dailyData": [
            {
                "statDate": "2025-10-01",
                "totalDrawCount": 2200,
                "totalCostPoints": 220000,
                "totalRewardPoints": 165000,
                "actualReturnRate": 75.0,
                "profitPoints": 55000,
                "uniqueUserCount": 330,
                "prizeLevelDistribution": {
                    "special": 2,
                    "first": 11,
                    "second": 44,
                    "third": 110,
                    "fourth": 220,
                    "fifth": 660,
                    "sixth": 880,
                    "noPrize": 273
                }
            }
            // ... å…¶ä»–æ—¥æœŸæ•°æ®
        ],
        "chartData": {
            "dates": ["10-01", "10-02", "10-03", "10-04", "10-05", "10-06", "10-07"],
            "drawCounts": [2200, 2300, 2100, 2400, 2150, 2250, 2400],
            "returnRates": [75.0, 74.5, 76.0, 75.2, 74.8, 75.5, 75.0],
            "profitPoints": [55000, 58650, 50400, 59520, 54180, 55125, 60000]
        }
    }
}
```

## ğŸ¨ å‰ç«¯ç•Œé¢è®¾è®¡

### 1. ç”¨æˆ·ç«¯æŠ½å¥–é¡µé¢ï¼ˆè½¬ç›˜æ ·å¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç§¯åˆ†æŠ½å¥–                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’° å½“å‰ç§¯åˆ†ï¼š1,850     ä»Šæ—¥å·²æŠ½ï¼š5æ¬¡      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              ğŸ° å¹¸è¿è½¬ç›˜                  â”‚
â”‚                                         â”‚
â”‚           â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²              â”‚
â”‚         â•± 50  â”‚1000â”‚ 20  â•²            â”‚
â”‚        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
â”‚        â”‚ 100 â”‚  ğŸ â”‚ 150 â”‚             â”‚
â”‚        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
â”‚         â•² 200 â”‚500â”‚ æœª  â•±              â”‚
â”‚           â•²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•±               â”‚
â”‚                                         â”‚
â”‚          [ç«‹å³æŠ½å¥– -100ç§¯åˆ†]             â”‚
â”‚                                         â”‚
â”‚ ğŸ’¡ æ¯æ¬¡æ¶ˆè€—100ç§¯åˆ†ï¼Œå¥–å“æœ€é«˜1000ç§¯åˆ†ï¼     â”‚
â”‚                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [æˆ‘çš„è®°å½•] [æŠ½å¥–è§„åˆ™] [æ¦‚ç‡å…¬ç¤º]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ç”¨æˆ·ç«¯æŠ½å¥–è®°å½•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æˆ‘çš„æŠ½å¥–è®°å½•                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Š ç»Ÿè®¡ä¿¡æ¯                              â”‚
â”‚ æ€»æŠ½å¥–ï¼š50æ¬¡  ä¸­å¥–ï¼š38æ¬¡  ä¸­å¥–ç‡ï¼š76%      â”‚
â”‚ æ€»æ¶ˆè€—ï¼š5,000ç§¯åˆ†  æ€»è·å¾—ï¼š3,750ç§¯åˆ†       â”‚
â”‚ å‡€æ”¶ç›Šï¼š-1,250ç§¯åˆ†                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“‹ æŠ½å¥–æ˜ç»†  [å…¨éƒ¨] [ä¸­å¥–] [æœªä¸­å¥–]       â”‚
â”‚                                         â”‚
â”‚ ğŸ äºŒç­‰å¥–  +200ç§¯åˆ†  æ¶ˆè€—100ç§¯åˆ†          â”‚
â”‚    å‡€æ”¶ç›Šï¼š+100  ä½™é¢ï¼š1,850ç§¯åˆ†           â”‚
â”‚    10-04 14:30:25                       â”‚
â”‚                                         â”‚
â”‚ ğŸ äº”ç­‰å¥–  +50ç§¯åˆ†   æ¶ˆè€—100ç§¯åˆ†          â”‚
â”‚    å‡€æ”¶ç›Šï¼š-50   ä½™é¢ï¼š1,650ç§¯åˆ†           â”‚
â”‚    10-04 14:25:18                       â”‚
â”‚                                         â”‚
â”‚ âŒ æœªä¸­å¥–  +0ç§¯åˆ†    æ¶ˆè€—100ç§¯åˆ†          â”‚
â”‚    å‡€æ”¶ç›Šï¼š-100  ä½™é¢ï¼š1,600ç§¯åˆ†           â”‚
â”‚    10-04 14:20:05                       â”‚
â”‚                                         â”‚
â”‚ [åŠ è½½æ›´å¤š]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. ç®¡ç†ç«¯æŠ½å¥–ç®¡ç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŠ½å¥–ç®¡ç†                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Š å®æ—¶æ•°æ®                              â”‚
â”‚ ä»Šæ—¥æŠ½å¥–ï¼š2,340æ¬¡  å‚ä¸ï¼š356äºº            â”‚
â”‚ æ¶ˆè€—ç§¯åˆ†ï¼š234,000  å¥–åŠ±ï¼š175,500          â”‚
â”‚ å›æŠ¥ç‡ï¼š75.0%  âœ…æ­£å¸¸  åˆ©æ¶¦ï¼š58,500ç§¯åˆ†    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ å¥–å“é…ç½®  [+ æ–°å¢å¥–å“]                 â”‚
â”‚                                         â”‚
â”‚ å¥–é¡¹     ç§¯åˆ†   åŸºç¡€æ¦‚ç‡  å½“å‰æ¦‚ç‡  å›æŠ¥ç‡   çŠ¶æ€    æ“ä½œ  â”‚
â”‚ ç‰¹ç­‰å¥–  1000   0.10%    0.08%â†“   1.22%â†‘  æš‚åœâ¸   [ç¼–è¾‘][æ¢å¤] â”‚
â”‚ ä¸€ç­‰å¥–   500   0.50%    0.48%â†“   2.51%â†‘  æ­£å¸¸âœ“   [ç¼–è¾‘][è°ƒæ•´] â”‚
â”‚ äºŒç­‰å¥–   200   2.00%    2.00%    3.98%   æ­£å¸¸âœ“   [ç¼–è¾‘][è°ƒæ•´] â”‚
â”‚ ä¸‰ç­‰å¥–   150   5.00%    5.00%    7.45%   æ­£å¸¸âœ“   [ç¼–è¾‘][è°ƒæ•´] â”‚
â”‚ å››ç­‰å¥–   100   10.00%   10.00%   9.98%   æ­£å¸¸âœ“   [ç¼–è¾‘][è°ƒæ•´] â”‚
â”‚ äº”ç­‰å¥–    50   30.00%   30.00%   14.95%  æ­£å¸¸âœ“   [ç¼–è¾‘][è°ƒæ•´] â”‚
â”‚ å…­ç­‰å¥–    20   40.00%   40.00%   8.02%   æ­£å¸¸âœ“   [ç¼–è¾‘][è°ƒæ•´] â”‚
â”‚ æœªä¸­å¥–     0   12.40%   12.44%â†‘  0%      æ­£å¸¸âœ“   [ç¼–è¾‘][è°ƒæ•´] â”‚
â”‚                                                            â”‚
â”‚ æ¦‚ç‡æ€»è®¡ï¼š100.0%  âœ…  å®é™…å›æŠ¥ï¼š74.8%  âœ…  ç›®æ ‡ï¼š75%         â”‚
â”‚ æœŸæœ›å›æŠ¥ï¼š75ç§¯åˆ†  å®é™…åˆ©æ¶¦ç‡ï¼š25.2%  çŠ¶æ€ï¼šæ­£å¸¸              â”‚
â”‚                                                            â”‚
â”‚ ğŸ”” é¢„è­¦ï¼šç‰¹ç­‰å¥–å›æŠ¥ç‡1.22%è¶…æ ‡ï¼ˆç›®æ ‡1%ï¼‰ï¼Œå·²è‡ªåŠ¨æš‚åœè‡³16:30  â”‚
â”‚                                                            â”‚
â”‚ [æ‰¹é‡è°ƒæ•´] [é‡ç½®å…¨éƒ¨] [å¯¼å‡ºé…ç½®] [è°ƒæ•´å†å²]                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“ˆ æ•°æ®ç»Ÿè®¡                              â”‚
â”‚ [ä»Šæ—¥] [æœ¬å‘¨] [æœ¬æœˆ] [è‡ªå®šä¹‰]             â”‚
â”‚                                         â”‚
â”‚ æŠ½å¥–è¶‹åŠ¿å›¾  ğŸ“Š                           â”‚
â”‚ [å›¾è¡¨å±•ç¤ºåŒºåŸŸ]                           â”‚
â”‚                                         â”‚
â”‚ æ”¶ç›Šåˆ†æ    ğŸ’°                           â”‚
â”‚ [å›¾è¡¨å±•ç¤ºåŒºåŸŸ]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âš ï¸ é£é™©æ§åˆ¶ä¸åº”æ€¥é¢„æ¡ˆ

### 1. é£é™©ç‚¹è¯†åˆ«

#### 1.1 æŠ€æœ¯é£é™©
- **å¹¶å‘å†²çª**: é«˜å¹¶å‘ä¸‹ç§¯åˆ†æ‰£å‡å’Œåº“å­˜æ‰£å‡å†²çª
  - **åº”å¯¹**: åˆ†å¸ƒå¼é” + æ•°æ®åº“è¡Œé” + äº‹åŠ¡éš”ç¦»
  
- **ç³»ç»Ÿæ•…éšœ**: æœåŠ¡å®•æœºå¯¼è‡´æŠ½å¥–ä¸­æ–­
  - **åº”å¯¹**: äº‹åŠ¡è¡¥å¿æœºåˆ¶ + æŠ½å¥–è®°å½•è¿½è¸ª

- **Redisæ•…éšœ**: ç¼“å­˜å¤±æ•ˆå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
  - **åº”å¯¹**: åŒå†™æ¨¡å¼ + æ•°æ®åº“å…œåº•

#### 1.2 ä¸šåŠ¡é£é™©
- **æ¦‚ç‡å¤±æ§**: å®é™…å›æŠ¥ç‡è¶…è¿‡é¢„æœŸ
  - **åº”å¯¹**: å®æ—¶ç›‘æ§ + è‡ªåŠ¨ç†”æ–­ + æ¦‚ç‡åŠ¨æ€è°ƒæ•´

- **æ¶æ„åˆ·å¥–**: ç”¨æˆ·åˆ©ç”¨æ¼æ´åˆ·å¥–
  - **åº”å¯¹**: å¤šç»´åº¦é˜²åˆ· + è¡Œä¸ºæ£€æµ‹ + é»‘åå•

- **è´¢åŠ¡äºæŸ**: å¤§é‡é«˜é¢å¥–å“ä¸­å¥–
  - **åº”å¯¹**: åº“å­˜é™åˆ¶ + æ¯æ—¥èµ”ä»˜ä¸Šé™ + ä¿é™©æœºåˆ¶

### 2. åº”æ€¥é¢„æ¡ˆ

#### 2.1 ç†”æ–­æœºåˆ¶
```java
@Component
public class LotteryCircuitBreaker {
    
    /**
     * ç†”æ–­è§¦å‘æ¡ä»¶
     */
    public boolean shouldBreak() {
        // 1. å›æŠ¥ç‡è¶…è¿‡90%
        if (getTodayReturnRate() > 0.90) {
            log.error("å›æŠ¥ç‡è¶…æ ‡ï¼Œè§¦å‘ç†”æ–­");
            return true;
        }
        
        // 2. è¿ç»­10æ¬¡ç‰¹ç­‰å¥–
        if (getRecentSpecialPrizeCount(10) >= 10) {
            log.error("ç‰¹ç­‰å¥–å¼‚å¸¸ï¼Œè§¦å‘ç†”æ–­");
            return true;
        }
        
        // 3. ç³»ç»Ÿè´Ÿè½½è¿‡é«˜
        if (getSystemLoad() > 0.95) {
            log.error("ç³»ç»Ÿè´Ÿè½½è¿‡é«˜ï¼Œè§¦å‘ç†”æ–­");
            return true;
        }
        
        return false;
    }
    
    /**
     * ç†”æ–­å¤„ç†
     */
    public void handleBreak() {
        // 1. æš‚åœæŠ½å¥–åŠŸèƒ½
        disableLottery();
        
        // 2. é€šçŸ¥ç®¡ç†å‘˜
        notifyAdmin("æŠ½å¥–ç³»ç»Ÿè§¦å‘ç†”æ–­ï¼Œå·²æš‚åœæœåŠ¡");
        
        // 3. è°ƒæ•´æ¦‚ç‡é…ç½®
        adjustProbabilityConfig();
        
        // 4. ç­‰å¾…æ¢å¤
        scheduleRecovery(30, TimeUnit.MINUTES);
    }
}
```

#### 2.2 é™çº§ç­–ç•¥
```java
public class LotteryDegradationStrategy {
    
    /**
     * é™çº§å¤„ç†
     */
    public LotteryResult degradedDraw(Long userId) {
        // 1. åœæ­¢å‘æ”¾é«˜ä»·å€¼å¥–å“
        List<LotteryPrize> lowValuePrizes = getPrizesUnder100Points();
        
        // 2. é™ä½å›æŠ¥ç‡åˆ°60%
        adjustExpectedReturn(0.60);
        
        // 3. é™åˆ¶æŠ½å¥–é¢‘ç‡
        enforceStrictRateLimit();
        
        // 4. æ‰§è¡Œé™çº§æŠ½å¥–
        return executeWithDegradation(userId, lowValuePrizes);
    }
}
```

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„æ€»ç»“

### è®¾è®¡æ¨¡å¼åº”ç”¨
- **ç­–ç•¥æ¨¡å¼**: å¯æ’æ‹”çš„æŠ½å¥–ç®—æ³•ï¼ˆAlias Methodã€åŠ¨æ€æƒé‡ã€ä¿åº•ç­–ç•¥ï¼‰
- **å·¥å‚æ¨¡å¼**: ç­–ç•¥å·¥å‚åŠ¨æ€åˆ›å»ºå’Œç®¡ç†æŠ½å¥–ç­–ç•¥
- **è´£ä»»é“¾æ¨¡å¼**: é£æ§æ£€æŸ¥é“¾ï¼ˆç§¯åˆ†æ£€æŸ¥â†’é¢‘ç‡é™åˆ¶â†’é»‘åå•æ£€æŸ¥ï¼‰
- **è§‚å¯Ÿè€…æ¨¡å¼**: äº‹ä»¶ç›‘å¬æœºåˆ¶ï¼ˆç»Ÿè®¡ç›‘å¬ã€å›æŠ¥ç‡ç›‘æ§ã€ç§¯åˆ†å˜åŠ¨ï¼‰
- **æ¨¡æ¿æ–¹æ³•æ¨¡å¼**: æŠ½å¥–æµç¨‹æ¨¡æ¿ï¼Œå­ç±»å®ç°å…·ä½“ç­–ç•¥

### æ ¸å¿ƒç‰¹æ€§
- **åŠ¨æ€æ¦‚ç‡è°ƒæ•´**: å®æ—¶ç›‘æ§å›æŠ¥ç‡ï¼Œè‡ªåŠ¨è°ƒæ•´å¥–å“æ¦‚ç‡
- **å•å“å›æŠ¥ç‡æ§åˆ¶**: æ¯ä¸ªå¥–å“ç‹¬ç«‹çš„å›æŠ¥ç‡ç›®æ ‡å’Œé˜ˆå€¼
- **è‡ªåŠ¨ç†”æ–­æœºåˆ¶**: å›æŠ¥ç‡è¶…æ ‡è‡ªåŠ¨æš‚åœé«˜ä»·å€¼å¥–å“
- **å¯æ‰©å±•æ¶æ„**: åŸºäºè®¾è®¡æ¨¡å¼ï¼Œæ˜“äºæ‰©å±•æ–°ç­–ç•¥å’ŒåŠŸèƒ½
- **å¼ºä¸€è‡´æ€§ä¿è¯**: åˆ†å¸ƒå¼é” + æ•°æ®åº“äº‹åŠ¡ + ä¹è§‚é”

## âœ… å®ç°èŒƒå›´

### ç¬¬ä¸€æœŸåŠŸèƒ½ï¼ˆv1.5.0ï¼‰

**åŸºç¡€åŠŸèƒ½ï¼š**
- âœ… **å¥–å“é…ç½®**: 8ä¸ªå¥–é¡¹ç­‰çº§ï¼Œçµæ´»çš„æ¦‚ç‡å’Œåº“å­˜é…ç½®
- âœ… **æŠ½å¥–ç®—æ³•**: Alias Methodä¼˜åŒ–ç®—æ³•ï¼ŒO(1)æ—¶é—´å¤æ‚åº¦
- âœ… **é˜²äºæŸæœºåˆ¶**: 75%å›æŠ¥ç‡è®¾è®¡ï¼Œ25%åˆ©æ¶¦ä¿è¯
- âœ… **é«˜å¹¶å‘æ”¯æŒ**: åˆ†å¸ƒå¼é” + Redisç¼“å­˜ï¼Œä¸‡çº§å¹¶å‘
- âœ… **å¼ºä¸€è‡´æ€§**: æ•°æ®åº“äº‹åŠ¡ + ä¹è§‚é”ï¼Œä¿è¯æ•°æ®å‡†ç¡®
- âœ… **é˜²åˆ·æœºåˆ¶**: é¢‘ç‡é™åˆ¶ + è¡Œä¸ºæ£€æµ‹ + é£é™©ç­‰çº§ç®¡ç†
- âœ… **ç”¨æˆ·ç•Œé¢**: è½¬ç›˜æŠ½å¥– + è®°å½•æŸ¥è¯¢ + è§„åˆ™å±•ç¤º

**åŠ¨æ€è°ƒæ•´åŠŸèƒ½ï¼ˆæ–°å¢ï¼‰ï¼š**
- âœ… **å•å“å›æŠ¥ç‡æ§åˆ¶**: æ¯ä¸ªå¥–å“ç‹¬ç«‹çš„å›æŠ¥ç‡ç›®æ ‡ã€é˜ˆå€¼ã€ç›‘æ§
- âœ… **å®æ—¶æ¦‚ç‡è°ƒæ•´**: åŸºäºå›æŠ¥ç‡è‡ªåŠ¨è°ƒæ•´å¥–å“æ¦‚ç‡
- âœ… **æ‰‹åŠ¨è°ƒæ•´æ¥å£**: ç®¡ç†å‘˜å¯æ‰‹åŠ¨è°ƒæ•´ä»»æ„å¥–å“æ¦‚ç‡
- âœ… **æ‰¹é‡è°ƒæ•´**: æ”¯æŒæ‰¹é‡è°ƒæ•´å¤šä¸ªå¥–å“é…ç½®
- âœ… **è°ƒæ•´å†å²è¿½è¸ª**: è®°å½•æ‰€æœ‰è‡ªåŠ¨å’Œæ‰‹åŠ¨è°ƒæ•´æ“ä½œ

**ç­–ç•¥æ¨¡å¼æ¶æ„ï¼ˆæ–°å¢ï¼‰ï¼š**
- âœ… **ç­–ç•¥æ¨¡å¼å®ç°**: å¯æ’æ‹”çš„æŠ½å¥–ç­–ç•¥ç³»ç»Ÿ
- âœ… **å·¥å‚æ¨¡å¼**: ç­–ç•¥å·¥å‚åŠ¨æ€ç®¡ç†
- âœ… **è´£ä»»é“¾æ¨¡å¼**: é£æ§æ£€æŸ¥é“¾
- âœ… **è§‚å¯Ÿè€…æ¨¡å¼**: äº‹ä»¶ç›‘å¬æœºåˆ¶
- âœ… **ç­–ç•¥åŠ¨æ€åˆ‡æ¢**: æ”¯æŒè¿è¡Œæ—¶åˆ‡æ¢æŠ½å¥–ç­–ç•¥

**ç›‘æ§ä¸ç®¡ç†ï¼ˆå¢å¼ºï¼‰ï¼š**
- âœ… **å®æ—¶ç›‘æ§å¤§ç›˜**: å…¨å±€å’Œå•å“çº§ç›‘æ§
- âœ… **å›æŠ¥ç‡è¶‹åŠ¿**: å›æŠ¥ç‡å†å²è¶‹åŠ¿åˆ†æ
- âœ… **è‡ªåŠ¨ç†”æ–­**: å›æŠ¥ç‡è¶…æ ‡è‡ªåŠ¨æš‚åœ
- âœ… **é¢„è­¦é€šçŸ¥**: å¤šçº§é¢„è­¦æœºåˆ¶
- âœ… **æ•°æ®åˆ†æ**: ROIåˆ†æã€ç”¨æˆ·è¡Œä¸ºåˆ†æ
- âœ… **ABæµ‹è¯•**: æ”¯æŒç­–ç•¥å¯¹æ¯”æµ‹è¯•

**ç®¡ç†åå°ï¼ˆå¢å¼ºï¼‰ï¼š**
- âœ… **å›æŠ¥ç‡é…ç½®**: å•å“å›æŠ¥ç‡ç›®æ ‡å’Œé˜ˆå€¼è®¾ç½®
- âœ… **è°ƒæ•´ç­–ç•¥é…ç½®**: AUTO/MANUAL/FIXEDæ¨¡å¼
- âœ… **æš‚åœæ¢å¤æ§åˆ¶**: æ‰‹åŠ¨/è‡ªåŠ¨æš‚åœå’Œå®šæ—¶æ¢å¤
- âœ… **æ¦‚ç‡è°ƒæ•´**: å®æ—¶æ‰‹åŠ¨è°ƒæ•´æ¦‚ç‡
- âœ… **ç­–ç•¥ç®¡ç†**: æŠ½å¥–ç­–ç•¥é…ç½®å’Œåˆ‡æ¢
- âœ… **åº”æ€¥é¢„æ¡ˆ**: é™çº§ç­–ç•¥ + äº‹åŠ¡è¡¥å¿ + æ‰‹åŠ¨å¹²é¢„

### ç¬¬äºŒæœŸåŠŸèƒ½ï¼ˆv1.6.0 - å¾…è§„åˆ’ï¼‰
- â³ **å¤šæ ·åŒ–æŠ½å¥–**: ä¹å®«æ ¼æŠ½å¥–ã€ç›²ç›’æŠ½å¥–ã€åˆ®åˆ®å¡
- â³ **å®ç‰©å¥–å“**: æ”¯æŒå®ç‰©å¥–å“é…ç½®å’Œå…‘æ¢æµç¨‹
- â³ **å¹¸è¿å€¼ç³»ç»Ÿ**: è¿ç»­æœªä¸­å¥–æå‡å¹¸è¿å€¼ï¼ŒåŠ¨æ€æå‡ä¸­å¥–æ¦‚ç‡
- â³ **ç»„é˜ŸæŠ½å¥–**: å¤šäººç»„é˜Ÿæå‡ä¸­å¥–æ¦‚ç‡ï¼Œç¤¾äº¤ç©æ³•
- â³ **é™æ—¶æ´»åŠ¨**: èŠ‚å‡æ—¥ç‰¹æ®ŠæŠ½å¥–æ´»åŠ¨ï¼Œä¸´æ—¶æå‡å›æŠ¥ç‡
- â³ **ç§¯åˆ†å¥—é¤**: å¤šæ¬¡æŠ½å¥–ä¼˜æƒ å¥—é¤ï¼ˆ10è¿æŠ½ã€50è¿æŠ½ï¼‰
- â³ **æ™ºèƒ½æ¨è**: AIæ¨èæœ€ä½³æŠ½å¥–æ—¶æœº
- â³ **ç”¨æˆ·åˆ†å±‚**: åŸºäºç”¨æˆ·ä»·å€¼çš„å·®å¼‚åŒ–ç­–ç•¥

## ğŸ“ å¼€å‘æ³¨æ„äº‹é¡¹

### æ ¸å¿ƒå®ˆåˆ™
1. **æ¦‚ç‡å½’ä¸€åŒ–**: æ¯æ¬¡è°ƒæ•´åå¿…é¡»é‡æ–°å½’ä¸€åŒ–ï¼Œç¡®ä¿æ€»æ¦‚ç‡=1.0
2. **å›æŠ¥ç‡ç›‘æ§**: å®æ—¶ç›‘æ§å…¨å±€å’Œå•å“å›æŠ¥ç‡ï¼Œè¶…æ ‡ç«‹å³å¤„ç†
3. **åˆ†å¸ƒå¼é”ç®¡ç†**: å¿…é¡»ä½¿ç”¨try-finallyç¡®ä¿é”é‡Šæ”¾ï¼Œé¿å…æ­»é”
4. **äº‹åŠ¡å®Œæ•´æ€§**: ç§¯åˆ†æ‰£å‡å’Œå¥–åŠ±å‘æ”¾å¿…é¡»åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼Œå¤±è´¥å›æ»š
5. **æ—¥å¿—å®Œæ•´æ€§**: è®°å½•æ‰€æœ‰æŠ½å¥–ã€è°ƒæ•´ã€å¼‚å¸¸æ“ä½œï¼Œä¾¿äºå®¡è®¡
6. **å¼‚å¸¸è¡¥å¿**: ä»»ä½•å¼‚å¸¸éƒ½è¦æœ‰è¡¥å¿æœºåˆ¶ï¼Œä¸èƒ½è®©ç”¨æˆ·æŸå¤±
7. **æµ‹è¯•è¦†ç›–**: é«˜å¹¶å‘ã€è¾¹ç•Œæ¡ä»¶ã€å›æŠ¥ç‡è¶…æ ‡ã€æ¦‚ç‡è°ƒæ•´ç­‰åœºæ™¯
8. **ç›‘æ§å‘Šè­¦**: å…³é”®æŒ‡æ ‡å®æ—¶ç›‘æ§ï¼Œå¼‚å¸¸ç«‹å³å‘Šè­¦

### åŠ¨æ€è°ƒæ•´æ³¨æ„äº‹é¡¹
1. **è°ƒæ•´é¢‘ç‡**: é¿å…è¿‡äºé¢‘ç¹è°ƒæ•´ï¼Œå»ºè®®è‡³å°‘é—´éš”100æ¬¡æŠ½å¥–æˆ–1å°æ—¶
2. **è°ƒæ•´å¹…åº¦**: å•æ¬¡è°ƒæ•´å¹…åº¦ä¸è¶…è¿‡åŸºç¡€æ¦‚ç‡çš„Â±20%
3. **å½’ä¸€åŒ–ç®—æ³•**: è°ƒæ•´åå¿…é¡»ä¿è¯æ‰€æœ‰æ¦‚ç‡ä¹‹å’Œ=1.0ï¼Œè¯¯å·®<0.0001
4. **è°ƒæ•´è®°å½•**: æ¯æ¬¡è°ƒæ•´éƒ½è¦è®°å½•ï¼ŒåŒ…æ‹¬åŸå› ã€æ“ä½œäººã€æ•ˆæœ
5. **å›æ»šæœºåˆ¶**: è°ƒæ•´æ•ˆæœä¸ä½³æ—¶ï¼Œæ”¯æŒå¿«é€Ÿå›æ»šåˆ°å†å²ç‰ˆæœ¬
6. **å¹¶å‘æ§åˆ¶**: è°ƒæ•´æ“ä½œéœ€è¦å…¨å±€é”ï¼Œé˜²æ­¢å¹¶å‘è°ƒæ•´å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

### è®¾è®¡æ¨¡å¼å®è·µ
1. **ç­–ç•¥æ¥å£ç»Ÿä¸€**: æ‰€æœ‰ç­–ç•¥å¿…é¡»å®ç°ç›¸åŒæ¥å£ï¼Œç¡®ä¿å¯æ›¿æ¢
2. **å·¥å‚æ³¨å†Œæœºåˆ¶**: æ–°ç­–ç•¥é€šè¿‡Springè‡ªåŠ¨æ³¨å†Œåˆ°å·¥å‚
3. **è´£ä»»é“¾é¡ºåº**: é£æ§é“¾çš„é¡ºåºå¾ˆé‡è¦ï¼Œå…ˆæ£€æŸ¥è½»é‡çº§çš„
4. **è§‚å¯Ÿè€…è§£è€¦**: äº‹ä»¶ç›‘å¬å™¨ä¹‹é—´å®Œå…¨è§£è€¦ï¼Œäº’ä¸å½±å“
5. **æ‰©å±•æ€§ä¼˜å…ˆ**: æ–°å¢åŠŸèƒ½ä¼˜å…ˆè€ƒè™‘é€šè¿‡æ‰©å±•è€Œéä¿®æ”¹

### æ€§èƒ½ä¼˜åŒ–
1. **Redisé¢„çƒ­**: ç³»ç»Ÿå¯åŠ¨æ—¶é¢„çƒ­å¥–å“é…ç½®åˆ°Redis
2. **æ¦‚ç‡ç¼“å­˜**: æ¦‚ç‡è°ƒæ•´åç«‹å³æ›´æ–°Redisç¼“å­˜
3. **æ‰¹é‡æ“ä½œ**: ç»Ÿè®¡å’Œè°ƒæ•´æ“ä½œå°½é‡æ‰¹é‡å¤„ç†
4. **å¼‚æ­¥å¤„ç†**: éå…³é”®è·¯å¾„æ“ä½œå¼‚æ­¥å¤„ç†ï¼ˆå¦‚ç»Ÿè®¡ã€ç›‘æ§ï¼‰
5. **è¿æ¥æ± **: åˆç†é…ç½®æ•°æ®åº“å’ŒRedisè¿æ¥æ± 

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

- **æŠ€æœ¯æŒ‡æ ‡**: 
  - æŠ½å¥–å“åº”æ—¶é—´ < 500ms (P99)
  - ç³»ç»Ÿæ”¯æŒå¹¶å‘é‡ > 10000 QPS
  - æ•°æ®ä¸€è‡´æ€§ = 100%
  - ç³»ç»Ÿå¯ç”¨æ€§ > 99.9%
  - æ¦‚ç‡è°ƒæ•´å»¶è¿Ÿ < 100ms

- **ä¸šåŠ¡æŒ‡æ ‡**:
  - å®é™…å›æŠ¥ç‡ = 75% Â± 2%
  - å¹³å°åˆ©æ¶¦ç‡ = 25% Â± 2%
  - ç”¨æˆ·å‚ä¸ç‡ > 30%
  - æ—¥å‡æŠ½å¥–é‡ > 5000æ¬¡
  - å•å“å›æŠ¥ç‡è¯¯å·® < 10%

- **ç”¨æˆ·ä½“éªŒ**:
  - æŠ½å¥–æˆåŠŸç‡ = 100% (æ— å¤±è´¥)
  - ç§¯åˆ†åˆ°è´¦å»¶è¿Ÿ < 1ç§’
  - ç”¨æˆ·æ»¡æ„åº¦ > 4.5/5
  - æŠ•è¯‰ç‡ < 0.1%
  - å›æŠ¥ç‡æ»¡æ„åº¦ > 70%
