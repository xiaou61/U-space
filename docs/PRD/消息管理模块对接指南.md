# 消息管理模块对接指南

## 一、消息系统架构概览

### 1.1 核心模块
- **xiaou-notification**: 专业的消息通知模块，提供用户端和管理端接口
- **xiaou-common**: 包含消息通知的公共工具类、实体类、枚举定义等
- **前端界面**: 管理端和用户端都已有完整的消息管理界面

### 1.2 技术架构
```
消息通知系统
├── 消息发送层 (NotificationUtil)
│   ├── 同步发送
│   ├── 异步发送  
│   ├── 批量发送
│   └── 模板消息
├── 消息服务层 (NotificationService)
│   ├── 消息入库
│   ├── 消息查询
│   └── 状态管理
├── 消息存储层 (Notification/NotificationConfig/NotificationTemplate)
│   ├── 消息记录
│   ├── 用户配置
│   └── 消息模板
└── 缓存优化层 (NotificationCacheUtil)
    ├── 未读数量缓存
    └── 配置缓存
```

### 1.3 消息类型支持
- **ANNOUNCEMENT**: 系统公告
- **PERSONAL**: 个人消息
- **COMMUNITY_INTERACTION**: 社区互动（点赞、评论、关注）
- **INTERVIEW_REMINDER**: 面试题相关提醒
- **SYSTEM_NOTIFICATION**: 系统通知
- **TEMPLATE**: 模板消息

## 二、各模块接入现状与需求

### 2.1 已完成接入
#### xiaou-notification ✅
- **状态**: 已完成
- **功能**: 核心消息管理模块
- **接口**: 提供完整的用户端和管理端API
- **前端**: 管理端和用户端界面已完成

#### xiaou-common ✅  
- **状态**: 已完成
- **功能**: 提供NotificationUtil工具类
- **使用方式**: `NotificationUtil.sendXxx()`

### 2.2 需要接入的模块

#### xiaou-community 🔄 (高优先级)
**现状**: 社区模块功能完整，但缺少消息通知集成

**需要接入的场景**:
1. **帖子互动**
   - 用户帖子被点赞 → 通知帖子作者
   - 用户帖子被评论 → 通知帖子作者
   - 用户帖子被收藏 → 通知帖子作者

2. **评论互动**
   - 用户评论被点赞 → 通知评论作者
   - 用户评论被回复 → 通知评论作者

3. **管理操作**
   - 帖子被置顶 → 通知帖子作者
   - 帖子被下架/删除 → 通知帖子作者
   - 用户被封禁 → 通知用户

**接入方法**:
```java
// 示例：帖子被点赞
NotificationUtil.sendCommunityMessage(
    postAuthorId, 
    "您的帖子收到新点赞", 
    "用户" + userName + "点赞了您的帖子《" + postTitle + "》", 
    postId.toString()
);
```

#### xiaou-interview 🔄 (高优先级)  
**现状**: 面试题模块功能完整，但缺少学习提醒等通知

**需要接入的场景**:
1. **学习提醒**
   - 题单收藏提醒
   - 学习进度提醒
   - 新题目发布通知

2. **互动通知**
   - 题单被其他用户收藏
   - 用户创建的题单被分享

**接入方法**:
```java
// 示例：题单被收藏
NotificationUtil.sendInterviewMessage(
    questionSetAuthorId,
    "您的题单被收藏",
    "用户" + userName + "收藏了您的题单《" + questionSetName + "》",
    questionSetId.toString()
);
```

#### xiaou-moment 🔄 (高优先级)
**现状**: 朋友圈功能完整，但缺少互动通知

**需要接入的场景**:
1. **动态互动**
   - 动态被点赞 → 通知动态作者
   - 动态被评论 → 通知动态作者
   - 评论被点赞 → 通知评论作者

**接入方法**:
```java
// 示例：动态被点赞
NotificationUtil.sendPersonalMessage(
    momentAuthorId,
    "您的动态收到新点赞", 
    "用户" + userName + "点赞了您的动态"
);
```

#### xiaou-user 🔄 (中优先级)
**现状**: 用户模块基础功能完整

**需要接入的场景**:
1. **账户安全**
   - 密码修改成功通知
   - 异地登录提醒
   - 账户信息变更通知

2. **系统消息**
   - 欢迎新用户消息
   - 重要功能更新通知

### 2.3 不需要接入的模块

#### xiaou-filestorage ❌
- **原因**: 文件存储为基础设施模块，主要服务于后端，用户无需感知文件操作过程

#### xiaou-system ❌
- **原因**: 系统管理模块主要面向管理员端，不涉及用户端消息通知

#### xiaou-monitor ❌  
- **原因**: 监控模块主要用于系统性能监控，属于管理员工具，不需要用户端消息

## 三、接入实施计划

### 3.1 第一阶段 (高优先级模块)
1. **xiaou-community**: 社区互动通知（点赞、评论、收藏）
2. **xiaou-interview**: 学习提醒通知（题单收藏、学习进度）
3. **xiaou-moment**: 朋友圈互动通知（动态点赞、评论）

### 3.2 第二阶段 (中优先级模块)
1. **xiaou-user**: 用户账户通知（密码修改、登录提醒等）

### 3.3 总体计划
- **核心目标**: 完成用户端相关的消息通知功能
- **预期效果**: 提升用户互动体验，增强平台活跃度
- **实施周期**: 建议分2个阶段完成，重点优先高频互动场景

## 四、接入技术指南

### 4.1 依赖配置
各业务模块需要依赖xiaou-common模块（通常已有）:
```xml
<dependency>
    <groupId>com.xiaou</groupId>
    <artifactId>xiaou-common</artifactId>
    <version>${project.version}</version>
</dependency>
```

### 4.2 使用方式
```java
// 1. 发送个人消息
NotificationUtil.sendPersonalMessage(receiverId, title, content);

// 2. 发送异步消息（推荐）
NotificationUtil.sendMessageAsync(receiverId, title, content);

// 3. 发送社区互动消息
NotificationUtil.sendCommunityMessage(receiverId, title, content, sourceId);

// 4. 发送面试题相关消息  
NotificationUtil.sendInterviewMessage(receiverId, title, content, sourceId);

// 5. 发送模板消息
Map<String, Object> params = new HashMap<>();
params.put("userName", "张三");
NotificationUtil.sendTemplateMessage(receiverId, "TEMPLATE_CODE", params);

// 6. 批量发送
List<Long> receiverIds = Arrays.asList(1L, 2L, 3L);
NotificationUtil.sendBatchMessage(receiverIds, title, content);

// 7. 发送系统公告
NotificationUtil.sendAnnouncement(title, content, priority);
```

### 4.3 最佳实践
1. **异步发送**: 优先使用`sendMessageAsync`避免阻塞主业务流程
2. **错误处理**: 消息发送失败不应影响主业务逻辑
3. **用户配置**: 发送前检查用户是否开启该类型消息接收
4. **消息去重**: 避免短时间内重复发送相同消息
5. **内容规范**: 消息标题简洁明了，内容包含必要的上下文信息

### 4.4 注意事项
1. **性能考虑**: 大批量消息发送建议分批处理
2. **存储优化**: 及时清理过期消息记录  
3. **缓存同步**: 发送消息后会自动清除相关缓存
4. **用户体验**: 避免频繁发送重复消息，影响用户体验
5. **异步优先**: 优先使用异步发送，避免阻塞主业务流程

## 五、前端界面现状

### 5.1 管理端界面 ✅
- **路径**: `/admin/notification`
- **功能**: 消息统计、列表查询、批量发送、系统公告
- **状态**: 已完成

### 5.2 用户端界面 ✅  
- **路径**: `/notification`
- **功能**: 消息列表、未读数量、标记已读、删除消息
- **状态**: 已完成

### 5.3 需要更新的导航
各模块接入消息通知后，可能需要在以下位置添加消息入口：
- 顶部导航栏消息图标
- 用户个人中心消息tab
- 相关功能页面的消息提示

## 六、数据库现状

### 6.1 已有表结构 ✅
- `notification`: 消息记录表
- `notification_config`: 用户消息配置表  
- `notification_template`: 消息模板表

### 6.2 字段支持
- 消息类型分类
- 来源模块标识
- 来源数据ID
- 优先级控制
- 状态管理

## 七、总结

### 7.1 接入范围确认
经过分析，需要接入消息通知的模块共**4个**：
- **xiaou-community**: 社区互动通知
- **xiaou-interview**: 学习提醒通知  
- **xiaou-moment**: 朋友圈互动通知
- **xiaou-user**: 用户账户通知

### 7.2 实施建议
消息通知系统的基础设施已经完备，主要工作是在各个业务模块的关键操作点集成消息发送逻辑。建议分2个阶段实施：

1. **优先级高**: 先完成社区、面试题、朋友圈三个模块的互动通知（用户感知度高）
2. **优先级中**: 再完成用户模块的账户安全通知

### 7.3 预期收益  
- 提升用户互动体验和平台粘性
- 增强用户对平台活动的感知度
- 完善产品的消息通知生态 